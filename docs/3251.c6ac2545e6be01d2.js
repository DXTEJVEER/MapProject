"use strict";var Br=Object.defineProperty,Ur=Object.defineProperties,Pr=Object.getOwnPropertyDescriptors,Cs=Object.getOwnPropertySymbols,Or=Object.prototype.hasOwnProperty,Lr=Object.prototype.propertyIsEnumerable,Fs=(xe,ae,M)=>ae in xe?Br(xe,ae,{enumerable:!0,configurable:!0,writable:!0,value:M}):xe[ae]=M,me=(xe,ae)=>{for(var M in ae||(ae={}))Or.call(ae,M)&&Fs(xe,M,ae[M]);if(Cs)for(var M of Cs(ae))Lr.call(ae,M)&&Fs(xe,M,ae[M]);return xe},Ae=(xe,ae)=>Ur(xe,Pr(ae));(self.webpackChunkbeachSports=self.webpackChunkbeachSports||[]).push([[3251],{76279:(xe,ae,M)=>{M.d(ae,{r:()=>K});var U=M(14259);function K(_,m){if(!(this instanceof K))return new K(_,m);this._maxEntries=Math.max(4,_||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),m&&("function"==typeof m?this.toBBox=m:this._initFormat(m)),this.clear()}function k(_,m,S){if(!S)return m.indexOf(_);for(var C=0;C<m.length;C++)if(S(_,m[C]))return C;return-1}function F(_,m){L(_,0,_.children.length,m,_)}function L(_,m,S,C,A){A||(A=E(null)),A.minX=1/0,A.minY=1/0,A.maxX=-1/0,A.maxY=-1/0;for(var O,R=m;R<S;R++)O=_.children[R],X(A,_.leaf?C(O):O);return A}function X(_,m){return _.minX=Math.min(_.minX,m.minX),_.minY=Math.min(_.minY,m.minY),_.maxX=Math.max(_.maxX,m.maxX),_.maxY=Math.max(_.maxY,m.maxY),_}function ne(_,m){return _.minX-m.minX}function z(_,m){return _.minY-m.minY}function V(_){return(_.maxX-_.minX)*(_.maxY-_.minY)}function ee(_){return _.maxX-_.minX+(_.maxY-_.minY)}function W(_,m){return(Math.max(m.maxX,_.maxX)-Math.min(m.minX,_.minX))*(Math.max(m.maxY,_.maxY)-Math.min(m.minY,_.minY))}function q(_,m){var S=Math.max(_.minX,m.minX),C=Math.max(_.minY,m.minY),A=Math.min(_.maxX,m.maxX),O=Math.min(_.maxY,m.maxY);return Math.max(0,A-S)*Math.max(0,O-C)}function b(_,m){return _.minX<=m.minX&&_.minY<=m.minY&&m.maxX<=_.maxX&&m.maxY<=_.maxY}function N(_,m){return m.minX<=_.maxX&&m.minY<=_.maxY&&m.maxX>=_.minX&&m.maxY>=_.minY}function E(_){return{children:_,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function P(_,m,S,C,A){for(var O,R=[m,S];R.length;)(S=R.pop())-(m=R.pop())<=C||(O=m+Math.ceil((S-m)/C/2)*C,(0,U.q)(_,O,m,S,A),R.push(m,O,O,S))}K.prototype={all:function(){return this._all(this.data,[])},search:function(_){var m=this.data,S=[],C=this.toBBox;if(!N(_,m))return S;for(var A,O,R,Y,Q=[];m;){for(A=0,O=m.children.length;A<O;A++)R=m.children[A],N(_,Y=m.leaf?C(R):R)&&(m.leaf?S.push(R):b(_,Y)?this._all(R,S):Q.push(R));m=Q.pop()}return S},collides:function(_){var m=this.data,S=this.toBBox;if(!N(_,m))return!1;for(var C,A,O,R,Y=[];m;){for(C=0,A=m.children.length;C<A;C++)if(O=m.children[C],N(_,R=m.leaf?S(O):O)){if(m.leaf||b(_,R))return!0;Y.push(O)}m=Y.pop()}return!1},load:function(_){if(!_||!_.length)return this;if(_.length<this._minEntries){for(var m=0,S=_.length;m<S;m++)this.insert(_[m]);return this}var C=this._build(_.slice(),0,_.length-1,0);if(this.data.children.length)if(this.data.height===C.height)this._splitRoot(this.data,C);else{if(this.data.height<C.height){var A=this.data;this.data=C,C=A}this._insert(C,this.data.height-C.height-1,!0)}else this.data=C;return this},insert:function(_){return _&&this._insert(_,this.data.height-1),this},clear:function(){return this.data=E([]),this},remove:function(_,m){if(!_)return this;for(var S,C,A,O,R=this.data,Y=this.toBBox(_),Q=[],w=[];R||Q.length;){if(R||(R=Q.pop(),C=Q[Q.length-1],S=w.pop(),O=!0),R.leaf&&-1!==(A=k(_,R.children,m)))return R.children.splice(A,1),Q.push(R),this._condense(Q),this;O||R.leaf||!b(R,Y)?C?(S++,R=C.children[S],O=!1):R=null:(Q.push(R),w.push(S),S=0,C=R,R=R.children[0])}return this},toBBox:function(_){return _},compareMinX:ne,compareMinY:z,toJSON:function(){return this.data},fromJSON:function(_){return this.data=_,this},_all:function(_,m){for(var S=[];_;)_.leaf?m.push.apply(m,_.children):S.push.apply(S,_.children),_=S.pop();return m},_build:function(_,m,S,C){var A,O=S-m+1,R=this._maxEntries;if(O<=R)return F(A=E(_.slice(m,S+1)),this.toBBox),A;C||(C=Math.ceil(Math.log(O)/Math.log(R)),R=Math.ceil(O/Math.pow(R,C-1))),(A=E([])).leaf=!1,A.height=C;var Y,Q,w,G,J=Math.ceil(O/R),he=J*Math.ceil(Math.sqrt(R));for(P(_,m,S,he,this.compareMinX),Y=m;Y<=S;Y+=he)for(P(_,Y,w=Math.min(Y+he-1,S),J,this.compareMinY),Q=Y;Q<=w;Q+=J)G=Math.min(Q+J-1,w),A.children.push(this._build(_,Q,G,C-1));return F(A,this.toBBox),A},_chooseSubtree:function(_,m,S,C){for(var A,O,R,Y,Q,w,G,J;C.push(m),!m.leaf&&C.length-1!==S;){for(G=J=1/0,A=0,O=m.children.length;A<O;A++)Q=V(R=m.children[A]),(w=W(_,R)-Q)<J?(J=w,G=Q<G?Q:G,Y=R):w===J&&Q<G&&(G=Q,Y=R);m=Y||m.children[0]}return m},_insert:function(_,m,S){var A=S?_:(0,this.toBBox)(_),O=[],R=this._chooseSubtree(A,this.data,m,O);for(R.children.push(_),X(R,A);m>=0&&O[m].children.length>this._maxEntries;)this._split(O,m),m--;this._adjustParentBBoxes(A,O,m)},_split:function(_,m){var S=_[m],C=S.children.length,A=this._minEntries;this._chooseSplitAxis(S,A,C);var O=this._chooseSplitIndex(S,A,C),R=E(S.children.splice(O,S.children.length-O));R.height=S.height,R.leaf=S.leaf,F(S,this.toBBox),F(R,this.toBBox),m?_[m-1].children.push(R):this._splitRoot(S,R)},_splitRoot:function(_,m){this.data=E([_,m]),this.data.height=_.height+1,this.data.leaf=!1,F(this.data,this.toBBox)},_chooseSplitIndex:function(_,m,S){var C,A,O,R,Y,Q,w,G;for(Q=w=1/0,C=m;C<=S-m;C++)R=q(A=L(_,0,C,this.toBBox),O=L(_,C,S,this.toBBox)),Y=V(A)+V(O),R<Q?(Q=R,G=C,w=Y<w?Y:w):R===Q&&Y<w&&(w=Y,G=C);return G},_chooseSplitAxis:function(_,m,S){var C=_.leaf?this.compareMinX:ne,A=_.leaf?this.compareMinY:z;this._allDistMargin(_,m,S,C)<this._allDistMargin(_,m,S,A)&&_.children.sort(C)},_allDistMargin:function(_,m,S,C){_.children.sort(C);var A,O,R=this.toBBox,Y=L(_,0,m,R),Q=L(_,S-m,S,R),w=ee(Y)+ee(Q);for(A=m;A<S-m;A++)O=_.children[A],X(Y,_.leaf?R(O):O),w+=ee(Y);for(A=S-m-1;A>=m;A--)O=_.children[A],X(Q,_.leaf?R(O):O),w+=ee(Q);return w},_adjustParentBBoxes:function(_,m,S){for(var C=S;C>=0;C--)X(m[C],_)},_condense:function(_){for(var m,S=_.length-1;S>=0;S--)0===_[S].children.length?S>0?(m=_[S-1].children).splice(m.indexOf(_[S]),1):this.clear():F(_[S],this.toBBox)},_initFormat:function(_){var m=["return a"," - b",";"];this.compareMinX=new Function("a","b",m.join(_[0])),this.compareMinY=new Function("a","b",m.join(_[1])),this.toBBox=new Function("a","return {minX: a"+_[0]+", minY: a"+_[1]+", maxX: a"+_[2]+", maxY: a"+_[3]+"};")}}},7547:(xe,ae,M)=>{var U,K,k,F,L,X,ne,z,V,ee,W,q,b,N,E,P,_,m,S,C,A,O,R,Y,Q,w,G,J,he,ie,ce,oe,Ie,$e,St,ht,et,lt,bt,tt,je,st,dt,Le,We,Ye,ct,gt,Ct,ft,rt,Ge,ke,pt,Ft,it,nt,Xe,_t,Mt,mt,g;M.d(ae,{$y:()=>O,AH:()=>K,CS:()=>ct,DD:()=>z,Dd:()=>he,Em:()=>A,JS:()=>We,Ky:()=>V,Lh:()=>gt,Qb:()=>nt,RL:()=>U,RS:()=>_t,TF:()=>C,Tx:()=>L,UR:()=>_,UX:()=>it,bj:()=>Ye,eZ:()=>ne,id:()=>Q,kP:()=>ht,r4:()=>tt,sj:()=>et,v2:()=>k,zQ:()=>J,zV:()=>P}),(g=U||(U={}))[g.BUTT=0]="BUTT",g[g.ROUND=1]="ROUND",g[g.SQUARE=2]="SQUARE",g[g.UNKNOWN=4]="UNKNOWN",function(g){g[g.BEVEL=0]="BEVEL",g[g.ROUND=1]="ROUND",g[g.MITER=2]="MITER",g[g.UNKNOWN=4]="UNKNOWN"}(K||(K={})),function(g){g[g.SCREEN=0]="SCREEN",g[g.MAP=1]="MAP"}(k||(k={})),function(g){g[g.Tint=0]="Tint",g[g.Ignore=1]="Ignore",g[g.Multiply=99]="Multiply"}(F||(F={})),function(g){g.Both="Both",g.JustBegin="JustBegin",g.JustEnd="JustEnd",g.None="None"}(L||(L={})),function(g){g[g.Mosaic=0]="Mosaic",g[g.Centered=1]="Centered"}(X||(X={})),function(g){g[g.Normal=0]="Normal",g[g.Superscript=1]="Superscript",g[g.Subscript=2]="Subscript"}(ne||(ne={})),function(g){g[g.MSSymbol=0]="MSSymbol",g[g.Unicode=1]="Unicode"}(z||(z={})),function(g){g[g.Unspecified=0]="Unspecified",g[g.TrueType=1]="TrueType",g[g.PSOpenType=2]="PSOpenType",g[g.TTOpenType=3]="TTOpenType",g[g.Type1=4]="Type1"}(V||(V={})),function(g){g[g.Display=0]="Display",g[g.Map=1]="Map"}(ee||(ee={})),function(g){g.None="None",g.Loop="Loop",g.Oscillate="Oscillate"}(W||(W={})),function(g){g[g.Z=0]="Z",g[g.X=1]="X",g[g.Y=2]="Y"}(q||(q={})),function(g){g[g.XYZ=0]="XYZ",g[g.ZXY=1]="ZXY",g[g.YXZ=2]="YXZ"}(b||(b={})),function(g){g[g.Rectangle=0]="Rectangle",g[g.RoundedRectangle=1]="RoundedRectangle",g[g.Oval=2]="Oval"}(N||(N={})),function(g){g[g.None=0]="None",g[g.Alpha=1]="Alpha",g[g.Screen=2]="Screen",g[g.Multiply=3]="Multiply",g[g.Add=4]="Add"}(E||(E={})),function(g){g[g.TTB=0]="TTB",g[g.RTL=1]="RTL",g[g.BTT=2]="BTT"}(P||(P={})),function(g){g[g.None=0]="None",g[g.SignPost=1]="SignPost",g[g.FaceNearPlane=2]="FaceNearPlane"}(_||(_={})),function(g){g[g.Float=0]="Float",g[g.String=1]="String",g[g.Boolean=2]="Boolean"}(m||(m={})),function(g){g[g.Intersect=0]="Intersect",g[g.Subtract=1]="Subtract"}(S||(S={})),function(g){g.OpenEnded="OpenEnded",g.Block="Block",g.Crossed="Crossed"}(C||(C={})),function(g){g.FullGeometry="FullGeometry",g.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",g.ReversedFirstSegment="ReversedFirstSegment",g.PerpendicularToSecondSegment="PerpendicularToSecondSegment",g.SecondSegmentWithTicks="SecondSegmentWithTicks",g.DoublePerpendicular="DoublePerpendicular",g.OppositeToFirstSegment="OppositeToFirstSegment",g.TriplePerpendicular="TriplePerpendicular",g.HalfCircleFirstSegment="HalfCircleFirstSegment",g.HalfCircleSecondSegment="HalfCircleSecondSegment",g.HalfCircleExtended="HalfCircleExtended",g.OpenCircle="OpenCircle",g.CoverageEdgesWithTicks="CoverageEdgesWithTicks",g.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",g.GapExtentMidline="GapExtentMidline",g.Chevron="Chevron",g.PerpendicularWithArc="PerpendicularWithArc",g.ClosedHalfCircle="ClosedHalfCircle",g.TripleParallelExtended="TripleParallelExtended",g.ParallelWithTicks="ParallelWithTicks",g.Parallel="Parallel",g.PerpendicularToFirstSegment="PerpendicularToFirstSegment",g.ParallelOffset="ParallelOffset",g.OffsetOpposite="OffsetOpposite",g.OffsetSame="OffsetSame",g.CircleWithArc="CircleWithArc",g.DoubleJog="DoubleJog",g.PerpendicularOffset="PerpendicularOffset",g.LineExcludingLastSegment="LineExcludingLastSegment",g.MultivertexArrow="MultivertexArrow",g.CrossedArrow="CrossedArrow",g.ChevronArrow="ChevronArrow",g.ChevronArrowOffset="ChevronArrowOffset",g.PartialFirstSegment="PartialFirstSegment",g.Arch="Arch",g.CurvedParallelTicks="CurvedParallelTicks",g.Arc90Degrees="Arc90Degrees"}(A||(A={})),function(g){g.Mitered="Mitered",g.Bevelled="Bevelled",g.Rounded="Rounded",g.Square="Square",g.TrueBuffer="TrueBuffer"}(O||(O={})),function(g){g.ClosePath="ClosePath",g.ConvexHull="ConvexHull",g.RectangularBox="RectangularBox"}(R||(R={})),function(g){g.BeginningOfLine="BeginningOfLine",g.EndOfLine="EndOfLine"}(Y||(Y={})),function(g){g.Mitered="Mitered",g.Bevelled="Bevelled",g.Rounded="Rounded",g.Square="Square"}(Q||(Q={})),function(g){g.Fast="Fast",g.Accurate="Accurate"}(w||(w={})),function(g){g.BeginningOfLine="BeginningOfLine",g.EndOfLine="EndOfLine"}(G||(G={})),function(g){g.Sinus="Sinus",g.Square="Square",g.Triangle="Triangle",g.Random="Random"}(J||(J={})),function(g){g[g.None=0]="None",g[g.Default=1]="Default",g[g.Force=2]="Force"}(he||(he={})),function(g){g[g.Buffered=0]="Buffered",g[g.Left=1]="Left",g[g.Right=2]="Right",g[g.AlongLine=3]="AlongLine"}(ie||(ie={})),function(g){g[g.Linear=0]="Linear",g[g.Rectangular=1]="Rectangular",g[g.Circular=2]="Circular",g[g.Buffered=3]="Buffered"}(ce||(ce={})),function(g){g[g.Discrete=0]="Discrete",g[g.Continuous=1]="Continuous"}(oe||(oe={})),function(g){g[g.AcrossLine=0]="AcrossLine",g[g.AloneLine=1]="AloneLine"}(Ie||(Ie={})),function(g){g[g.Left=0]="Left",g[g.Right=1]="Right",g[g.Center=2]="Center",g[g.Justify=3]="Justify"}($e||($e={})),function(g){g[g.Base=0]="Base",g[g.MidPoint=1]="MidPoint",g[g.ThreePoint=2]="ThreePoint",g[g.FourPoint=3]="FourPoint",g[g.Underline=4]="Underline",g[g.CircularCW=5]="CircularCW",g[g.CircularCCW=6]="CircularCCW"}(St||(St={})),function(g){g.Butt="Butt",g.Round="Round",g.Square="Square"}(ht||(ht={})),function(g){g.NoConstraint="NoConstraint",g.HalfPattern="HalfPattern",g.HalfGap="HalfGap",g.FullPattern="FullPattern",g.FullGap="FullGap",g.Custom="Custom"}(et||(et={})),function(g){g[g.None=-1]="None",g[g.Custom=0]="Custom",g[g.Circle=1]="Circle",g[g.OpenArrow=2]="OpenArrow",g[g.ClosedArrow=3]="ClosedArrow",g[g.Diamond=4]="Diamond"}(lt||(lt={})),function(g){g[g.ExtraLeading=0]="ExtraLeading",g[g.Multiple=1]="Multiple",g[g.Exact=2]="Exact"}(bt||(bt={})),function(g){g.Bevel="Bevel",g.Round="Round",g.Miter="Miter"}(tt||(tt={})),function(g){g[g.Default=0]="Default",g[g.String=1]="String",g[g.Numeric=2]="Numeric"}(je||(je={})),function(g){g[g.InsidePolygon=0]="InsidePolygon",g[g.PolygonCenter=1]="PolygonCenter",g[g.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(st||(st={})),function(g){g[g.Tint=0]="Tint",g[g.Replace=1]="Replace",g[g.Multiply=2]="Multiply"}(dt||(dt={})),function(g){g[g.ClipAtBoundary=0]="ClipAtBoundary",g[g.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",g[g.DoNotTouchBoundary=2]="DoNotTouchBoundary",g[g.DoNotClip=3]="DoNotClip"}(Le||(Le={})),function(g){g.NoConstraint="NoConstraint",g.WithMarkers="WithMarkers",g.WithFullGap="WithFullGap",g.WithHalfGap="WithHalfGap",g.Custom="Custom"}(We||(We={})),function(g){g.Fixed="Fixed",g.Random="Random",g.RandomFixedQuantity="RandomFixedQuantity"}(Ye||(Ye={})),function(g){g.LineMiddle="LineMiddle",g.LineBeginning="LineBeginning",g.LineEnd="LineEnd",g.SegmentMidpoint="SegmentMidpoint"}(ct||(ct={})),function(g){g.OnPolygon="OnPolygon",g.CenterOfMass="CenterOfMass",g.BoundingBoxCenter="BoundingBoxCenter"}(gt||(gt={})),function(g){g[g.Low=0]="Low",g[g.Medium=1]="Medium",g[g.High=2]="High"}(Ct||(Ct={})),function(g){g[g.MarkerCenter=0]="MarkerCenter",g[g.MarkerBounds=1]="MarkerBounds"}(ft||(ft={})),function(g){g[g.None=0]="None",g[g.PropUniform=1]="PropUniform",g[g.PropNonuniform=2]="PropNonuniform",g[g.DifUniform=3]="DifUniform",g[g.DifNonuniform=4]="DifNonuniform"}(rt||(rt={})),function(g){g.Tube="Tube",g.Strip="Strip",g.Wall="Wall"}(Ge||(Ge={})),function(g){g[g.Random=0]="Random",g[g.Increasing=1]="Increasing",g[g.Decreasing=2]="Decreasing",g[g.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(ke||(ke={})),function(g){g[g.Relative=0]="Relative",g[g.Absolute=1]="Absolute"}(pt||(pt={})),function(g){g[g.Normal=0]="Normal",g[g.LowerCase=1]="LowerCase",g[g.Allcaps=2]="Allcaps"}(Ft||(Ft={})),function(g){g[g.LTR=0]="LTR",g[g.RTL=1]="RTL"}(it||(it={})),function(g){g.Draft="Draft",g.Picture="Picture",g.Text="Text"}(nt||(nt={})),function(g){g[g.Top=0]="Top",g[g.Center=1]="Center",g[g.Baseline=2]="Baseline",g[g.Bottom=3]="Bottom"}(Xe||(Xe={})),function(g){g[g.Right=0]="Right",g[g.Upright=1]="Upright"}(_t||(_t={})),function(g){g[g.Small=0]="Small",g[g.Medium=1]="Medium",g[g.Large=2]="Large"}(Mt||(Mt={})),function(g){g[g.Calm=0]="Calm",g[g.Rippled=1]="Rippled",g[g.Slight=2]="Slight",g[g.Moderate=3]="Moderate"}(mt||(mt={}))},99666:(xe,ae,M)=>{M.d(ae,{KS:()=>V,PX:()=>L,QS:()=>W,_I:()=>U,jL:()=>z,nE:()=>ee,vs:()=>ne,xp:()=>X});const U=8388607,K=8388608,L=0,X=1,ne=q=>(q&K)>>>23,z=q=>q&U,V=q=>ne(q)===X?254:255;function ee(q){return ne(q)===X}function W(q,b){return((b?K:0)|q)>>>0}},39351:(xe,ae,M)=>{M.d(ae,{$0:()=>W,AI:()=>k,By:()=>oe,C1:()=>g,CQ:()=>Tt,CU:()=>ke,Ex:()=>A,I_:()=>X,Ic:()=>G,Ij:()=>ie,Ip:()=>Xe,Iv:()=>Ce,Iw:()=>O,MI:()=>mt,SD:()=>Zt,Tz:()=>Ue,Uh:()=>Ot,V4:()=>Ge,XJ:()=>nt,_6:()=>zt,a:()=>pt,aK:()=>st,e0:()=>Et,eV:()=>q,f2:()=>ce,fL:()=>it,iJ:()=>J,jk:()=>wt,kF:()=>et,m4:()=>We,mx:()=>Ie,nM:()=>he,oK:()=>Lt,pU:()=>je,ru:()=>L,tQ:()=>ft,uG:()=>Ye,xl:()=>tt,xm:()=>b,yP:()=>lt});const k=1e-30,L=4294967295,X=512,W=8,q=10,b=29,A=24,O=8,G=0,J=1,he=2,ie=3,ce=4,oe=5,Ie=6,et=5,lt=6,tt=1,je=2,st=3,We=2,Ye=1,ft=1.05,Ge=5,ke=6,pt=1.15,it=2,nt=8,Xe=500,mt=10,g=1024,Ot=2,Tt=0,Ue=1,Lt=4,Et=8,Ce=16,zt=4,Zt=1,wt=4},5254:(xe,ae,M)=>{M.d(ae,{Au:()=>q,Jz:()=>E,UJ:()=>N});const U=new Float32Array(1);function q(m){return[255&m,(65280&m)>>>8,(16711680&m)>>>16,(4278190080&m)>>>24]}function N(m,S){return 65535&m|S<<16}function E(m,S,C,A){return 255&m|(255&S)<<8|(255&C)<<16|A<<24}new Uint32Array(U.buffer)},55746:(xe,ae,M)=>{M.d(ae,{k:()=>q,p:()=>b});var U=M(65389),K=M(61885),F=(M(8314),M(62208)),L=M(76279),X=M(5548),ne=M(16669),z=M(52397);function V(N,E){return N<<16|E}function ee(N){return(4294901760&N)>>>16}function W(N){return 65535&N}const q={getObjectId:N=>N.getObjectId(),getAttributes:N=>N.readAttributes(),getAttribute:(N,E)=>N.readAttribute(E),cloneWithGeometry:(N,E)=>N,getGeometry:N=>N.readHydratedGeometry(),getCentroid:(N,E)=>N.readCentroid()};class b extends ne.J{constructor(E,P,_){super(E,P),this.featureAdapter=q,this.events=new K.Z,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new U.Z(50),this._index=(0,L.r)(9,m=>({minX:this._storage.getXMin(m),minY:this._storage.getYMin(m),maxX:this._storage.getXMax(m),maxY:this._storage.getYMax(m)})),this.mode=_}get storeStatistics(){let E=0,P=0,_=0;return this.forEach(m=>{const S=m.readGeometry();S&&(P+=S.isPoint?1:S.lengths.reduce((C,A)=>C+A,0),_+=S.isPoint?1:S.lengths.length,E+=1)}),{featureCount:E,vertexCount:P,ringCount:_}}hasInstance(E){return this._featureSetsByInstance.has(E)}onTileData(E,P){if((0,F.Wi)(P.addOrUpdate))return P;if(P.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const m=P.addOrUpdate.getCursor();for(;m.next();){const S=m.getDisplayId();this.setComputedAttributes(this._storage,m,S,E.scale)}return P}this._featureSetsByInstance.set(P.addOrUpdate.instance,P.addOrUpdate);const _=P.addOrUpdate.getCursor();for(;_.next();)this._insertFeature(_,E.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),P}search(E){this._rebuildIndex();const P=E.id,_=this._indexSearchCache.find(A=>A.tileId===P);if((0,F.pC)(_))return _.readers;const m=new Map,S=this._searchIndex(E.bounds),C=[];for(const A of S){const O=this._storage.getInstanceId(A),R=ee(O),Y=W(O);m.has(R)||m.set(R,[]),m.get(R).push(Y)}return m.forEach((A,O)=>{const R=this._featureSetsByInstance.get(O);C.push(z.t.from(R,A))}),this._indexSearchCache.enqueue({tileId:P,readers:C}),C}insert(E){var m;const P=E.getCursor(),_=this._storage;for(;P.next();){const S=V(P.instance,P.getIndex()),C=P.getObjectId(),A=null!=(m=this._objectIdToDisplayId.get(C))?m:this._storage.createDisplayId();P.setDisplayId(A),_.setInstanceId(A,S),this._objectIdToDisplayId.set(C,A)}this._featureSetsByInstance.set(E.instance,E),this._spatialIndexInvalid=!0}remove(E){const P=this._objectIdToDisplayId.get(E);if(!P)return;const _=this._storage.getInstanceId(P),m=W(_),S=ee(_),C=this._featureSetsByInstance.get(S);this._objectIdToDisplayId.delete(E),this._storage.releaseDisplayId(P),C.removeAtIndex(m),C.isEmpty&&this._featureSetsByInstance.delete(S),this._spatialIndexInvalid=!0}toArray(){const E=new Array;return this.forEach(P=>E.push(P)),E}forEach(E){this._objectIdToDisplayId.forEach(P=>{const _=this._storage.getInstanceId(P),m=this._lookupFeature(_);E(m)})}forEachUnsafe(E){this._objectIdToDisplayId.forEach(P=>{const _=this._storage.getInstanceId(P),m=ee(_),S=W(_),C=this._getFeatureSet(m);C.setIndex(S),E(C)})}forEachInBounds(E,P){const _=this._searchIndex(E);for(const m of _){const S=this.lookupFeatureByDisplayId(m,this._storage);P((0,F.Wg)(S))}}forEachBounds(E,P,_){this._rebuildIndex();const m=[0,0,0,0];for(const S of E){if(!S.readGeometry())continue;const C=S.getDisplayId();m[0]=this._storage.getXMin(C),m[1]=this._storage.getYMin(C),m[2]=this._storage.getXMax(C),m[3]=this._storage.getYMax(C),P((0,X.JR)(_,m))}}sweepFeatures(E,P,_){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((m,S)=>{E.has(m)||(P.releaseDisplayId(m),_&&_.unsetAttributeData(m),this._objectIdToDisplayId.delete(S))}),this.events.emit("changed")}sweepFeatureSets(E){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((P,_)=>{E.has(_)||this._featureSetsByInstance.delete(_)})}lookupObjectId(E,P){const _=this.lookupFeatureByDisplayId(E,P);return(0,F.Wi)(_)?null:_.getObjectId()}lookupDisplayId(E){return this._objectIdToDisplayId.get(E)}lookupFeatureByDisplayId(E,P){const _=P.getInstanceId(E);return this._lookupFeature(_)}lookupByDisplayIdUnsafe(E){const P=this._storage.getInstanceId(E),_=ee(P),m=W(P),S=this._getFeatureSet(_);return S?(S.setIndex(m),S):null}_insertFeature(E,P){const _=this._storage,m=E.getObjectId(),S=V(E.instance,E.getIndex());_.getInstanceId(E.getDisplayId());let C=this._objectIdToDisplayId.get(m);C||(C=_.createDisplayId(),this._objectIdToDisplayId.set(m,C),this._spatialIndexInvalid=!0),E.setDisplayId(C),_.setInstanceId(C,S),this.setComputedAttributes(_,E,C,P)}_searchIndex(E){return this._rebuildIndex(),this._index.search({minX:E[0],minY:E[1],maxX:E[2],maxY:E[3]})}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const E=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(P=>{const _=P.getCursor();for(;_.next();){const m=_.getDisplayId();this._storage.setBounds(m,_)&&E.push(m)}}):this._objectIdToDisplayId.forEach(P=>{const _=this._storage.getInstanceId(P);this._storage.setBounds(P,this._lookupFeature(_))&&E.push(P)}),this._index.clear(),this._index.load(E),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(E){const P=ee(E),_=this._getFeatureSet(P);if(!_)return null;const m=_.getCursor(),S=W(E);return m.setIndex(S),m}_getFeatureSet(E){return this._featureSetsByInstance.get(E)}}},11288:(xe,ae,M)=>{M.r(ae),M.d(ae,{default:()=>Rr});var U=M(15861),K=M(17626),k=M(80542),F=M(8314),L=M(32917),X=M(77712),V=(M(85931),M(90912),M(76898)),ee=M(37053),W=M(2584),b=M(62208),N=M(10699),E=M(82054),P=M(58175),_=M(60466),m=M(55746),S=M(38305),C=M(84792),A=M(26584),O=M(63290),R=M(93662),Y=M(7848),Q=M(89628),w=M(20477),G=M(66385),J=M(25208);class ie extends J.s{constructor(a,u,h){super(a,h),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=null==h?void 0:h.geometryType,this._features=u}static fromFeatures(a,u){const{objectIdField:h,geometryType:d}=u,f=(0,E.Yn)([],a,d,!1,!1,h);for(let p=0;p<f.length;p++)f[p].displayId=a[p].displayId;return ie.fromOptimizedFeatures(f,u)}static fromFeatureSet(a,u){const h=(0,E.h_)(a,u.objectIdField);return ie.fromOptimizedFeatureSet(h,u)}static fromOptimizedFeatureSet(a,u){const{features:h}=a,d=ie.fromOptimizedFeatures(h,u);d._exceededTransferLimit=a.exceededTransferLimit,d._transform=a.transform;for(const f of a.fields)"esriFieldTypeDate"===f.type&&d._dateFields.add(f.name);return d}static fromOptimizedFeatures(a,u,h){const d=J.s.createInstance(),f=new ie(d,a,u);return f._transform=h,f}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(a){const u=new Set(a);this._features=this._features.filter(h=>!u.has(h.objectId))}append(a){for(const u of a)this._features.push(u)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let a="";for(const u in this._current.attributes)a+=this._current.attributes[u];return a}getIndex(){return this._featureIndex}setIndex(a){this._featureIndex=a}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(a){this._current.displayId=a}getGroupId(){return this._current.groupId}setGroupId(a){this._current.groupId=a}copy(){const a=new ie(this.instance,this._features,this.fullSchema());return this.copyInto(a),a}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,E.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const a=this.readGeometry();return(0,E.di)(a,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const a=this.readCentroid();return(0,b.Wi)(a)?null:{x:a.coords[0]*this._sx+this._tx,y:a.coords[1]*this._sy+this._ty}}readGeometryArea(){return(0,G.S6)(this._current)?(0,E.lz)(this._current.geometry,2):0}readUnquantizedGeometry(){const a=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!a)return a;const u=a.clone();return function he({coords:c,lengths:a}){let u=0;for(const h of a){for(let d=1;d<h;d++)c[2*(u+d)]+=c[2*(u+d)-2],c[2*(u+d)+1]+=c[2*(u+d)-1];u+=h}}(u),u}readHydratedGeometry(){const a=this._current.geometry;if((0,b.Wi)(a))return null;const u=a.clone();return(0,b.pC)(this._transform)&&(0,E.$g)(u,u,this.hasZ,this.hasM,this._transform),u}getXHydrated(){if(!(0,G.S6)(this._current))return 0;const a=this._current.geometry.coords[0],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:a*u.scale[0]+u.translate[0]}getYHydrated(){if(!(0,G.S6)(this._current))return 0;const a=this._current.geometry.coords[1],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:u.translate[1]-a*u.scale[1]}getX(){return(0,G.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return(0,G.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!(0,G.S6)(this._current))return null;const a=this._current.geometry.clone();if(a.isPoint)return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sy+this._ty,a;let u=0;for(const h of a.lengths)a.coords[2*u]=a.coords[2*u]*this._sx+this._tx,a.coords[2*u+1]=a.coords[2*u+1]*this._sy+this._ty,u+=h;return a}readCentroid(){if(!(0,G.S6)(this._current))return null;if((0,b.Wi)(this._current.centroid)){const u=this._computeCentroid();if((0,b.Wi)(u))return null;u.coords[0]=(u.coords[0]-this._tx)/this._sx,u.coords[1]=(u.coords[1]-this._ty)/this._sy,this._current.centroid=u}const a=this._current.centroid.clone();return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sx+this._ty,a}hasField(a){return a in this._current.attributes||this.getFieldNames().map(u=>u.toLowerCase()).includes(a.toLowerCase())}getFieldNames(){return Object.keys(this._current.attributes)}_readAttribute(a,u){const h=this._current.attributes[a];if(void 0!==h)return null!=h&&u&&this._dateFields.has(a)?new Date(h):h;const d=this.readAttributes(),f=a.toLocaleLowerCase().trim();for(const p in d)if(p.toLocaleLowerCase().trim()===f){const y=this._current.attributes[p];return null!=y&&u&&this._dateFields.has(p)?new Date(y):y}}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._transform=this._transform,a._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}var ce=M(24192),oe=M(88071),Ie=M(71260);const $e=268435455;class St{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(a){return this.fieldMap.has(a)}isDateField(a){var u;return null==(u=this.fieldMap.get(a))?void 0:u.isDate}getFieldIndex(a){var u;return null==(u=this.fieldMap.get(a))?void 0:u.index}}function ht(c){const h=c.getLength(),d=c.pos()+h,f={name:"",isDate:!1};for(;c.pos()<d&&c.next();)switch(c.tag()){case 1:f.name=c.getString();break;case 2:"esriFieldTypeDate"===(0,Ie.O7)(c.getEnum())&&(f.isDate=!0);break;default:c.skip()}return f}function et(c){return c.toLowerCase().trim()}const bt=O.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),je=268435455,Le={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function We(c){return c<=Le.small.delta.length?Le.small:(c<=Le.large.delta.length||(Le.large.delta=new Int32Array(Math.round(1.25*c)),Le.large.decoded=new Int32Array(Math.round(1.25*c))),Le.large)}function Ye(c){return c.toLowerCase().trim()}function gt(c){for(;c.next();){if(1===c.tag())return c.getMessage();c.skip()}return null}function ft(c,a,u,h,d,f){return.5*Math.abs(c*h+u*f+d*a-c*f-u*a-d*h)}function rt(c,a,u,h){return c*h-u*a==0&&c*u+a*h>0}class Ge extends J.s{constructor(a,u,h,d){super(a,d),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=d.geometryType,this._reader=u,this._header=h,this._hasNext=h.hasFeatures,this._isPoints="esriGeometryPoint"===d.geometryType}static fromBuffer(a,u,h=!1){const d=u.geometryType,f=function ct(c){try{const u=new ce.Z(new Uint8Array(c),new DataView(c));for(;u.next();){if(2===u.tag())return gt(u.getMessage());u.skip()}}catch(a){const u=new A.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:a});bt.error(u)}return null}(a),p=function lt(c,a,u=!1){const v=c.pos(),x=new St;let T=0,B=0,H=null,re=null,te=null,ue=!1;for(;c.next();)switch(c.tag()){case 1:H=c.getString();break;case 3:re=c.getString();break;case 12:te=c.processMessage(Ie.G$);break;case 9:if(x.exceededTransferLimit=c.getBool(),x.exceededTransferLimit){x.offsets.geometry=u?new Float64Array(8e3):new Int32Array(8e3),x.centroid=u?new Float64Array(16e3):new Int32Array(16e3);for(let $=0;$<x.centroid.length;$++)x.centroid[$]=$e}break;case 13:{const $=ht(c),fe=$.name,ve=et($.name),de={fieldName:fe,index:T++,isDate:$.isDate};x.fields.push(de),x.fieldMap.set($.name,de),x.fieldMap.set(ve,de);break}case 15:{const $=c.getLength(),fe=c.pos()+$;if(!x.exceededTransferLimit){const _e=x.centroid;x.offsets.geometry.push(0),_e.push($e),_e.push($e)}!ue&&x.exceededTransferLimit&&(ue=!0,x.offsets.attributes=u?new Float64Array(8e3*T):new Uint32Array(8e3*T));let ve=B*T;for(;c.pos()<fe&&c.next();)switch(c.tag()){case 1:{ue?x.offsets.attributes[ve++]=c.pos():x.offsets.attributes.push(c.pos());const de=c.getLength();c.skipLen(de);break}case 2:if(a){const de=c.getLength(),_e=c.pos()+de;for(;c.pos()<_e&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const pe=c.getSInt64(),Re=c.getSInt64();x.centroid[2*B]=pe,x.centroid[2*B+1]=Re;break}default:c.skip()}}else{x.offsets.geometry[B]=c.pos();const de=c.getLength();x.vertexCount+=de,c.skipLen(de)}break;case 4:{const de=c.getLength(),_e=c.pos()+de;for(;c.pos()<_e&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const pe=c.getSInt64(),Re=c.getSInt64();x.centroid[2*B]=pe,x.centroid[2*B+1]=Re;break}default:c.skip()}break}default:c.skip()}B++,x.hasFeatures=!0;break}default:c.skip()}const le=H||re;if(!le)throw new A.Z("FeatureSet has no objectId or globalId field name");return x.featureCount=B,x.fieldCount=T,x.objectIdFieldIndex=x.getFieldIndex(le),x.transform=te,x.displayIds=new Uint32Array(x.featureCount),x.groupIds=new Uint16Array(x.featureCount),c.move(v),x}(f,"esriGeometryPoint"===d,h),y=J.s.createInstance();return new Ge(y,f,p,u)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(a){return this._header.hasField(a)||this._header.hasField(Ye(a))}getFieldNames(){return this._header.fields.map(a=>a.fieldName)}getSize(){return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=a}getAttributeHash(){let a="";return this._header.fields.forEach(({index:u})=>{a+=this._readAttributeAtIndex(u)+"."}),a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=a}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(a){this._header.groupIds[this._featureIndex]=a}readLegacyFeature(){var a;if(void 0===this._cache.legacyFeature){const u=this.readCentroid(),h={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(a=u&&{x:u.coords[0],y:u.coords[1]})?a:null};return this._cache.legacyFeature=h,h}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const a=new G.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return a.objectId=this.getObjectId(),a.displayId=this.getDisplayId(),this._cache.optFeature=a,a}return this._cache.optFeature}getXHydrated(){const a=this._header.centroid[2*this._featureIndex],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:a*u.scale[0]+u.translate[0]}getYHydrated(){const a=this._header.centroid[2*this._featureIndex+1],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:u.translate[1]-a*u.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(a){const u=this.readGeometry(a);return(0,E.di)(u,this.geometryType,!1,!1)}readLegacyCentroid(){const a=this.readCentroid();if(!a)return null;const[u,h]=a.coords;return{x:u,y:h}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(a=!1){if(void 0===this._cache.unquantGeometry){const u=this.readGeometry(a);if(!u)return this._cache.unquantGeometry=null,null;const h=We(u.coords.length).decoded,d=u.clone(h),f=d.coords;let p=0;for(const y of d.lengths){for(let I=1;I<y;I++){const v=2*(p+I),x=2*(p+I-1);f[v]+=f[x],f[v+1]+=f[x+1]}p+=y}return this._cache.unquantGeometry=d,d}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===je)return null;const d=this.getXHydrated(),f=this.getYHydrated();return new oe.Z([],[d,f])}const a=this.readGeometry();if(!a)return null;const u=a.clone(),h=this.getQuantizationTransform();return(0,b.pC)(h)&&(0,E.$g)(u,u,this.hasZ,this.hasM,h),u}readGeometry(a=!1){if(void 0===this._cache.geometry){let u=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===je)return null;const h=this.getX(),d=this.getY();u=new oe.Z([],[h,d])}else{const h=this._header.offsets.geometry[this._featureIndex],d=this._reader;if(0===h)return null;d.move(h);try{u=a?this._parseGeometryForDisplay(d):this._parseGeometry(d)}catch(f){return console.error("Failed to parse geometry!",f),null}}return this._cache.geometry=u,u}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let a=null;const u=this._header.centroid[2*this._featureIndex]+this._tx,h=this._header.centroid[2*this._featureIndex+1]+this._ty;return u===je?(a=this._computeCentroid(),a&&(this._header.centroid[2*this._featureIndex]=a.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=a.coords[1]-this._ty)):a=new oe.Z([],[u,h]),this._cache.centroid=a,a}return this._cache.centroid}copy(){const a=this._reader.clone(),u=new Ge(this.instance,a,this._header,this.fullSchema());return this.copyInto(u),u}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}_readAttribute(a,u){const h=this._header.hasField(a)?a:Ye(a),d=this._header.getFieldIndex(h);if(null==d)return;const f=this._readAttributeAtIndex(d);return u&&null!=f&&this._header.isDateField(h)?new Date(f):f}_readAttributes(){const a={};return this._header.fields.forEach(({fieldName:u,index:h})=>{a[u]=this._readAttributeAtIndex(h)}),a}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._featureOffset=this._featureOffset,a._hasNext=this._hasNext}_readAttributeAtIndex(a){const h=this._reader;return h.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]),function Ct(c){const x=c.getLength(),T=c.pos()+x;for(;c.pos()<T&&c.next();)switch(c.tag()){case 1:return c.getString();case 2:return c.getFloat();case 3:return c.getDouble();case 4:return c.getSInt32();case 5:return c.getUInt32();case 6:return c.getInt64();case 7:return c.getUInt64();case 8:return c.getSInt64();case 9:return c.getBool();default:return c.skip(),null}return null}(h)}_parseGeometry(a){const d=a.getLength(),f=a.pos()+d,p=[],y=[];for(;a.pos()<f&&a.next();)switch(a.tag()){case 2:{const I=a.getUInt32(),v=a.pos()+I;for(;a.pos()<v;)y.push(a.getUInt32());break}case 3:{const I=a.getUInt32(),v=a.pos()+I;for(p.push(a.getSInt32()+this._tx),p.push(a.getSInt32()+this._ty),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();a.pos()<v;)p.push(a.getSInt32()),p.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break}default:a.skip()}return new oe.Z(y,p)}_parseGeometryForDisplay(a){const d=a.getLength(),f=a.pos()+d,p=[],y=[];let I=0,v=0,x=null,T=0;const B="esriGeometryPolygon"===this.geometryType;for(;a.pos()<f&&a.next();)switch(a.tag()){case 2:{const D=a.getUInt32(),Z=a.pos()+D;for(;a.pos()<Z;){const j=a.getUInt32();p.push(j),I+=j}x=We(2*I).delta;break}case 3:{a.getUInt32();const D=2+(this.hasZ?1:0)+(this.hasM?1:0);for(const Z of p)if(v+D*Z>x.length)for(let j=0;j<Z;j++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(B){const j=this.getAreaSimplificationThreshold(Z,this._header.vertexCount);let se=2,H=1;const re=!1;let te=a.getSInt32(),ue=a.getSInt32();x[v++]=te,x[v++]=ue,this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();let le=a.getSInt32(),$=a.getSInt32();for(this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();se<Z;){let fe=a.getSInt32(),ve=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();const de=te+le,_e=ue+$;ft(te,ue,de,_e,de+fe,_e+ve)>=j?(T+=-.5*(de-te)*(_e+ue),H>1&&rt(x[v-2],x[v-1],le,$)?(x[v-2]+=le,x[v-1]+=$):(x[v++]=le,x[v++]=$,H++),te=de,ue=_e):(fe+=le,ve+=$),le=fe,$=ve,se++}H<3||re?v-=2*H:(T+=-.5*(te+le-te)*(ue+$+ue),rt(x[v-2],x[v-1],le,$)?(x[v-2]+=le,x[v-1]+=$,y.push(H)):(x[v++]=le,x[v++]=$,y.push(++H)))}else{let j=0,se=a.getSInt32(),H=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),x[v++]=se,x[v++]=H,j+=1;for(let re=1;re<Z;re++){const te=a.getSInt32(),ue=a.getSInt32(),le=se+te,$=H+ue;T+=-.5*(le-se)*($+H),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),re>2&&rt(x[v-2],x[v-1],te,ue)?(x[v-2]+=te,x[v-1]+=ue):(x[v++]=te,x[v++]=ue,j+=1),se=le,H=$}y.push(j)}break}default:a.skip()}if(this._cache.area=T,!y.length)return null;if(this._tx||this._ty){let D=0;for(const Z of y)x[2*D]+=this._tx,x[2*D+1]+=this._ty,D+=Z}return new oe.Z(y,x)}}class ke{constructor(a){this.service=a}destroy(){}}function Xe(){return(Xe=(0,U.Z)(function*(c){const a=new R.Z;return yield a.open(c,{}),a})).apply(this,arguments)}class _t extends ke{constructor(a){super(a),this._portsOpen=function nt(c){return Xe.apply(this,arguments)}(a.source).then(u=>this.client=u)}destroy(){this.client.close(),this.client=null}executeQuery(a,u){var h=this;return(0,U.Z)(function*(){yield h._portsOpen;const d=yield h.client.invoke("queryFeatures",a.toJSON(),u);return ie.fromFeatureSet(d,h.service)})()}}class Mt extends ke{executeQuery(a,u){var h=this;return(0,U.Z)(function*(){const{data:d}=yield(0,w.executeQueryPBFBuffer)(h.service.source,a,u);return Ge.fromBuffer(d,h.service,!a.quantizationParameters)})()}}class mt extends ke{executeQuery(a,u){var h=this;return(0,U.Z)(function*(){var x;const{source:d,capabilities:f,spatialReference:p,objectIdField:y,geometryType:I}=h.service;if((0,b.pC)(a.quantizationParameters)&&!f.query.supportsQuantization){const T=a.clone(),B=(0,Y.vY)((0,b.Wg)(T.quantizationParameters));T.quantizationParameters=null;const{data:D}=yield(0,w.executeQuery)(d,T,p,u),Z=(0,E.h_)(D,y);return(0,E.RZ)(B,Z),ie.fromOptimizedFeatureSet(Z,h.service)}const{data:v}=yield(0,w.executeQuery)(d,a,h.service.spatialReference,u);return"esriGeometryPoint"===I&&(v.features=null==(x=v.features)?void 0:x.filter(T=>{if((0,b.pC)(T.geometry)){const B=T.geometry;return Number.isFinite(B.x)&&Number.isFinite(B.y)}return!0})),ie.fromFeatureSet(v,h.service)})()}}class g extends ke{executeQuery(a,u){var h=this;return(0,U.Z)(function*(){const{capabilities:d}=h.service;if(a.quantizationParameters&&!d.query.supportsQuantization){const p=a.clone(),y=(0,Y.vY)((0,b.Wg)(p.quantizationParameters));p.quantizationParameters=null;const I=yield(0,Q.WW)(h.service.source,a,u);return(0,E.RZ)(y,I),ie.fromOptimizedFeatureSet(I,h.service)}const f=yield(0,Q.WW)(h.service.source,a,u);return ie.fromOptimizedFeatureSet(f,h.service)})()}}var Ot=M(97478),Tt=M(61885),Ue=M(84682),Lt=M(84952),Et=M(65389);class Ce{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(a){const u=new Ce;for(const h in a){const d=a[h];if("object"==typeof d)for(const f in d)u[h][f]=d[f];u[h]=d}return u}static empty(){return Ce.create({})}static all(){return Ce.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(a){this.version=a.version,a.source&&(this.source=!1),a.targets.feature&&(this.targets.feature=!1),a.targets.aggregate&&(this.targets.aggregate=!1),a.storage.filters&&(this.storage.filters=!1),a.storage.data&&(this.storage.data=!1),a.mesh&&(this.mesh=!1),a.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let a=0,u="";if(this.mesh){a+=20,u+="-> (20) Mesh needs update\n";for(const d of this.why.mesh)u+=`    + ${d}\n`}if(this.source){a+=10,u+="-> (10) The source needs update\n";for(const d of this.why.source)u+=`    + ${d}\n`}this.targets.feature&&(a+=5,u+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(a+=5,u+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(a+=4,u+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(a+=1,u+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${a<5?"Fastest":a<10?"Fast":a<15?"Moderate":a<20?"Slow":"Very Slow"} update of cost ${a}/45 `),console.debug(u)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class zt{constructor(a,u){this.requests={done:new Array,stream:new Et.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=a,this._version=u}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(u=>u.message.status.unset(a)),this._version=a.version,(0,b.pC)(this._edits)&&this._edits.status.unset(a)}add(a){var u;a.message.status=null!=(u=a.message.status)?u:Ce.empty(),a.message.status.version=this._version,(0,F.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),a.message.end&&this.requests.done.forEach(h=>{(0,b.pC)(h.message)&&h.message.end&&(h.message.end=!1)}),this.requests.done.push(a)}edit(a,u){const h=a.getQuantizationTransform(),d=a.fullSchema(),f=Array.from(a.features()),p=[...u,...f.map(y=>y.objectId)];this.removeIds(p),this._invalidate(),(0,b.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:ie.fromOptimizedFeatures(f,d,(0,b.Wg)(h)),id:this.tile.id,status:Ce.empty(),end:!0}:(this.requests.done.forEach(y=>y.message.end=!1),(0,b.Wg)(this._edits.addOrUpdate).append(a.features()))}*readers(){for(const{message:a}of this.requests.done)(0,b.pC)(a.addOrUpdate)&&(yield a.addOrUpdate);(0,b.pC)(this._edits)&&(0,b.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=Ce.empty();(0,b.pC)(this._edits)&&(this._edits.status=Ce.empty())}removeIds(a){this._invalidate();for(const{message:u}of this.requests.done){const h=u.addOrUpdate;(0,b.pC)(h)&&(h.removeIds(a),h.isEmpty&&(u.addOrUpdate=null))}(0,b.pC)(this._edits)&&(0,b.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(a),this.requests.done=this.requests.done.filter(u=>u.message.addOrUpdate||u.message.end)}abort(){this._abortController.abort()}}class wt{constructor(a){this.events=new Tt.Z,this._resolver=(0,N.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=a.outSR,this._serviceInfo=a.serviceInfo,this._onTileUpdateMessage=a.onMessage}destroy(){}_onMessage(a){var u=this;return(0,U.Z)(function*(){var f,p;const h=u._subscriptions.get(a.id);if(!h)return;const d=Ae(me({},a),{remove:null!=(f=a.remove)?f:[],status:null!=(p=a.status)?p:Ce.empty()});return(0,N.R8)(u._onTileUpdateMessage(d,h.options))})()}update(a,u){var I;const h=u.fields.length;u.outFields=function Zt(c,a){const u=new Set;return c&&c.forEach(h=>u.add(h)),a&&a.forEach(h=>u.add(h)),u.has("*")?["*"]:Array.from(u)}(null==(I=this._schema)?void 0:I.outFields,u.outFields),u.outFields=u.outFields.length>=.75*h?["*"]:u.outFields,u.outFields.sort();const d=(0,Ue.Hg)(this._schema,u);if(!d)return;(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",d);const f="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",p={returnCentroid:(0,F.Z)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:u.outFields,outSpatialReference:this._outSR,orderByFields:[f],where:u.definitionExpression||"1=1",gdbVersion:u.gdbVersion,historicMoment:u.historicMoment,timeExtent:Ot.Z.fromJSON(u.timeExtent)},y=this._schema&&(0,Ue.uD)(d,"outFields");this._schema&&(0,Ue.V7)(d,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(a.why.mesh.push("Layer filter and/or custom parameters changed"),a.why.source.push("Layer filter and/or custom parameters changed"),a.mesh=!0,a.source=!0,a.queryFilter=!0),y&&(a.why.source.push("Layer required fields changed"),a.source=!0),(0,Ue.Hg)(p,this._queryInfo)&&(this._queryInfo=p),this._schema=u,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(a){var u=this;return(0,U.Z)(function*(){if(a.queryFilter||a.source&&u._didEdit)return u.refresh(a.version),void(u._didEdit=!1);u._subscriptions.forEach(h=>h.applyUpdate(a)),yield u.resend()})()}refresh(a){for(const u of this._tiles())this.unsubscribe(u),this.subscribe(u,a)}subscribe(a,u){const h=new zt(a,u);this._subscriptions.set(a.id,h)}unsubscribe(a){const u=this.get(a.id);(0,b.pC)(u)&&u.abort(),this._subscriptions.delete(a.id)}createQuery(a={}){const u=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new Lt.Z(me(Ae(me({},this._queryInfo),{historicMoment:u}),a))}get(a){return this._subscriptions.has(a)?this._subscriptions.get(a):null}queryLastEditDate(){return(0,U.Z)(function*(){throw new Error("Service does not support query type")})()}query(a){return(0,U.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const a=Array.from(this._subscriptions.values());for(const u of a)yield u.tile}edit(a,u){var h=this;return(0,U.Z)(function*(){const d=Array.from(h._subscriptions.values()),f=d.map(({tile:p})=>p);for(const p of d)p.removeIds(u);if(a.length){const p=f.map(I=>{const v=h.createTileQuery(I);return v.objectIds=a,{tile:I,query:v}}).map(function(){var I=(0,U.Z)(function*({tile:v,query:x}){return{tile:v,result:yield h.query(x),query:x}});return function(v){return I.apply(this,arguments)}}()),y=(yield(0,N.WW)(p)).map(function(){var I=(0,U.Z)(function*({tile:v,result:x}){if(!x.hasFeatures&&!u.length&&!a.length)return;const T=h._subscriptions.get(v.key.id);T&&T.edit(x,a)});return function(v){return I.apply(this,arguments)}}());yield(0,N.as)(y)}h._didEdit=!0})()}}var Nt=M(71251);const Ms=O.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");class Gt extends wt{constructor(a){var u,h;super(a),u=this,this.type="feature",this.mode="on-demand",this._adapter=function it(c){const{capabilities:a}=c;return function Ft(c){return c&&c.capabilities&&c.collection&&c.layerDefinition}(c.source)?new g(c):function pt(c){return Array.isArray(c.source)}(c)?new _t(c):a.query.supportsFormatPBF&&(0,F.Z)("featurelayer-pbf")?new Mt(c):new mt(c)}(a.serviceInfo),this._queue=new Nt.e({concurrency:8,process:(h=(0,U.Z)(function*(d){if((0,N.k_)(d),(0,b.pC)(d.tile)){const f=d.tile.key.id,{signal:p}=d,y=(0,F.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:d.depth}:void 0,I=yield u._adapter.executeQuery(d.query,{signal:p,query:me(me({},y),u._schema.customParameters)});return I.level=d.tile.key.level,I}return u._adapter.executeQuery(d.query,Ae(me({},d),{query:u._schema.customParameters}))}),function(f){return h.apply(this,arguments)})}),this._patchQueue=new Nt.e({concurrency:8,process:function(){var h=(0,U.Z)(function*(d){if((0,N.k_)(d),(0,b.pC)(d.tile)){const f=d.tile.key.id,{signal:p}=d,y=(0,F.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:d.depth}:void 0,I=yield u._adapter.executeQuery(d.query,{signal:p,query:me(me({},y),u._schema.customParameters)});return I.level=d.tile.key.level,I}return u._adapter.executeQuery(d.query,Ae(me({},d),{query:u._schema.customParameters}))});return function(f){return h.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(a=>!a.done)}get maxRecordCountFactor(){const{query:a}=this._serviceInfo.capabilities;return a.supportsMaxRecordCountFactor?4:null}get maxPageSize(){var u;const{query:a}=this._serviceInfo.capabilities;return(null!=(u=a.maxRecordCount)?u:8e3)*(0,b.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(a,u){}subscribe(a,u){super.subscribe(a,u);const h=this._subscriptions.get(a.id);this._fetchDataTile(a).catch(d=>{(0,N.D_)(d)||Ms.error(new A.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:d}))}).then(()=>h.end())}unsubscribe(a){super.unsubscribe(a)}readers(a){return this._subscriptions.get(a).readers()}query(a){var u=this;return(0,U.Z)(function*(){return u._adapter.executeQuery(a,{query:u._schema.customParameters})})()}queryLastEditDate(){var a=this;return(0,U.Z)(function*(){const u=a._serviceInfo.source,h=Ae(me({},u.query),{f:"json"});return(yield(0,C.default)(u.path,{query:h,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(a,u={}){var p;const h=this._serviceInfo.geometryType,d=this.createQuery(u);d.quantizationParameters=null!=(p=u.quantizationParameters)?p:a.getQuantizationParameters(),d.resultType="tile",d.geometry=a.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===h&&(d.maxAllowableOffset=a.resolution*(0,F.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==h&&"esriGeometryPolygon"!==h||(d.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===h&&(d.maxAllowableOffset*=(0,F.Z)("feature-polyline-generalization-factor")));const f=this._serviceInfo.capabilities.query;return d.defaultSpatialReferenceEnabled=f.supportsDefaultSpatialReference,d.compactGeometryEnabled=f.supportsCompactGeometry,d}_executePatchQuery(a,u,h,d){var f=this;return(0,U.Z)(function*(){const p=u.clone();p.outFields=[f._serviceInfo.objectIdField,...h],p.returnCentroid=!1,p.returnGeometry=!1;const y=(0,b.pC)(p.start)?p.start/8e3:0;return f._patchQueue.push({tile:a,query:p,signal:d.signal,depth:y})})()}_resend(a,u){var h=this;return(0,U.Z)(function*(){const{query:d,message:f}=a,p=(0,b.pC)(d.outFields)?d.outFields:[],y=h._queryInfo.outFields,I=y.filter(v=>!p.includes(v));if((0,b.Wi)(f.addOrUpdate))h._onMessage(Ae(me({},f),{type:"append"}));else if(I.length)try{const v=h._subscriptions.get(f.id).tile,x=yield h._executePatchQuery(v,d,I,u);(0,N.k_)(u),d.outFields=y,f.addOrUpdate.joinAttributes(x),h._onMessage(Ae(me({},f),{end:f.end,type:"append"}))}catch(v){}else h._onMessage(Ae(me({},f),{type:"append"}))})()}_resendSubscription(a){var u=this;return(0,U.Z)(function*(){if((0,F.Z)("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription"),a.empty)return u._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const h=a.signal;for(const d of a.requests.done)yield u._resend(d,{signal:h});return(0,b.pC)(a.edits)?u._onMessage(a.edits):void 0})()}resend(){var a=this;return(0,U.Z)(function*(){const u=Array.from(a._subscriptions.values());yield Promise.all(u.map(h=>a._resendSubscription(h)))})()}}const Jt=(0,F.Z)("esri-mobile"),$t={maxDrillLevel:Jt?1:4,maxRecordCountFactor:Jt?1:3};class As extends Gt{constructor(a){super(a)}_fetchDataTile(a){var u=this;return(0,U.Z)(function*(){const h=u._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,d=u._subscriptions.get(a.key.id),f=d.signal,p=a.getQuantizationParameters();let y=0;const I=function(){var v=(0,U.Z)(function*(x,T){const B=u._queryInfo,D=u.createTileQuery(x,{maxRecordCountFactor:h?$t.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:p});y++;try{const Z=yield u._queue.push({tile:a,query:D,signal:f,depth:T});if(y--,(0,N.k_)(f),!Z)return;if(B!==u._queryInfo)return void I(x,T);if(Z.exceededTransferLimit&&T<$t.maxDrillLevel){for(const se of x.createChildTiles())I(se,T+1);return}const j={id:a.id,addOrUpdate:Z,end:0===y,type:"append"};d.add({query:D,message:j}),u._onMessage(j)}catch(Z){(0,N.D_)(Z)||u._onMessage({id:a.id,addOrUpdate:null,end:!0,type:"append"})}});return function(T,B){return v.apply(this,arguments)}}();I(a,0)})()}}var es=M(76279),Es=M(5075),ws=M(16147);function Ds(c,a){const u=c.weakClone();if((0,b.pC)(c.geometry)){const h=(0,E.Jd)(a,c.geometry.coords[0]),d=(0,E.IN)(a,c.geometry.coords[1]);u.geometry=new oe.Z([],[h,d])}return u}class Ls{constructor(a,u){this.onUpdate=a,this._geometryType=u,this._objectIdToFeature=new Map}get _features(){const a=[];return this._objectIdToFeature.forEach(u=>a.push(u)),a}add(a){this._objectIdToFeature.set(a.objectId,a),this._index=null}get(a){return this._objectIdToFeature.has(a)?this._objectIdToFeature.get(a):null}forEach(a){this._objectIdToFeature.forEach(a)}search(a){return this._index||(this._index=function Ps(c,a){const u=(0,es.r)(9,function Us(c){return"esriGeometryPoint"===c?a=>(0,b.pC)(a.geometry)?{minX:a.geometry.coords[0],minY:a.geometry.coords[1],maxX:a.geometry.coords[0],maxY:a.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:a=>{let u=1/0,h=1/0,d=-1/0,f=-1/0;return(0,b.pC)(a.geometry)&&a.geometry.forEachVertex((p,y)=>{u=Math.min(u,p),h=Math.min(h,y),d=Math.max(d,p),f=Math.max(f,y)}),{minX:u,minY:h,maxX:d,maxY:f}}}(a));return u.load(c),u}(this._features,this._geometryType)),function Os(c,a){return c.search({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]})}(this._index,a)}removeById(a){const u=this._objectIdToFeature.get(a);return u?(this._objectIdToFeature.delete(a),this._index=null,u):null}update(a,u){this.onUpdate(a,u)}get size(){return this._objectIdToFeature.size}}class zs extends wt{constructor(a){super(a),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:u}=a,{geometryType:h,objectIdField:d,timeInfo:f,purgeOptions:p,source:y,spatialReference:I,serviceFilter:v,maxReconnectionAttempts:x,maxReconnectionInterval:T,updateInterval:B,enableDataReceived:D,customParameters:Z}=a.serviceInfo,j=new Ls(this._onUpdate.bind(this),h),se=new Es.Qo(j,d,f,p),H=(0,ws.I)(y,I,u,h,v,x,T,Z);this._store=j,this._manager=se,this._connection=H,this._quantize=function Bs(c){return"esriGeometryPoint"===c?Ds:(a,u)=>{const h=a.weakClone(),d=new oe.Z,y=(0,E.Nh)(d,a.geometry,!1,!1,c,u,!1,!1);return h.geometry=y,h}}(h),this._dataReceiveEventEnabled=D,this._handles=[this._connection.on("feature",re=>this._onFeature(re)),(0,L.YP)(()=>H.connectionStatus,re=>this.events.emit("connectionStatus",re)),(0,L.YP)(()=>H.errorString,re=>this.events.emit("errorString",re))],this._initUpdateInterval=()=>{let re=performance.now();this._updateIntervalId=setInterval(()=>{const te=performance.now(),ue=te-re;if(ue>2500){re=te;const le=Math.round(this._updateInfo.client/(ue/1e3)),$=Math.round(this._updateInfo.websocket/(ue/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:le,websocket:$})}a.canAcceptRequest()&&this._manager.checkForUpdates()},B)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(a=>a.remove()),this._connection.destroy()}_fetchDataTile(){}pauseStream(){this._clearUpdateInterval()}resumeStream(){this._initUpdateInterval()}enableEvent(a,u){"data-received"===a&&(this._dataReceiveEventEnabled=u)}get updating(){return!1}subscribe(a,u){super.subscribe(a,u);const h=this._subscriptions.get(a.id);this._level=a.level;const d=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:d,end:!0}),h.didSend=!0}unsubscribe(a){super.unsubscribe(a)}*readers(a){const u=this._subscriptions.get(a),{tile:h}=u;yield this._getTileFeatures(h);for(const d of u.requests.stream.entries)(0,b.pC)(d)&&(0,b.pC)(d.addOrUpdate)&&(yield d.addOrUpdate)}createTileQuery(a){throw new Error("Service does not support tile  queries")}resend(){var a=this;return(0,U.Z)(function*(){a._subscriptions.forEach(u=>{const{tile:h}=u,d={type:"append",id:h.id,addOrUpdate:a._getTileFeatures(h),end:!0};a._onMessage(d)})})()}_getTileFeatures(a){const u=this._store.search(a).map(h=>this._quantize(h,a.transform));return ie.fromOptimizedFeatures(u,this._serviceInfo,a.transform)}_onFeature(a){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",a);const u=(0,E.XA)(a,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(u)}catch(u){}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(a,u){(0,b.pC)(a)&&(this._updateInfo.client+=a.length),this._subscriptions.forEach((h,d)=>{h.didSend&&h.tile.level===this._level&&this._onMessage({type:"append",id:d,addOrUpdate:null,clear:!0,end:!1})}),this._subscriptions.forEach((h,d)=>{if(!h.didSend||h.tile.level!==this._level)return;const p={type:"append",id:d,addOrUpdate:this._getTileFeatures(h.tile),remove:[],end:!0,status:Ce.empty()};h.requests.stream.enqueue(p),this._onMessage(p)})}}const Zs=O.Z.getLogger("esri.views.2d.layers.features.sources.FeatureSource");class Ns extends Gt{constructor(a){super(a)}_fetchDataTile(a){var u=this;return(0,U.Z)(function*(){const f=u._subscriptions.get(a.key.id);let p=!1,y=0,I=0;const v=(B,D)=>{I--,(0,N.k_)(f);const Z=a.id,j=B.reader,se=B.query;if(!j.exceededTransferLimit){if(p=!0,0!==D&&!j.hasFeatures){const te={id:Z,addOrUpdate:j,end:0===I,type:"append"};return f.add({message:te,query:se}),void u._onMessage(te)}const re={id:Z,addOrUpdate:j,end:0===I,type:"append"};return f.add({message:re,query:se}),void u._onMessage(re)}const H={id:Z,addOrUpdate:j,end:p&&0===I,type:"append"};f.add({message:H,query:se}),u._onMessage(H)};let x=0,T=0;for(;!p&&T++<20;){let B;for(let D=0;D<x+1;D++){const Z=y++;I++,B=u._fetchDataTilePage(a,Z,f).then(j=>j&&v(j,Z)).catch(j=>{p=!0,(0,N.D_)(j)||(Zs.error(new A.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:j})),u._onMessage({id:a.id,addOrUpdate:null,end:p,type:"append"}))})}yield B,(0,N.k_)(f),x=Math.min(x+2,6)}})()}_fetchDataTilePage(a,u,h){var d=this;return(0,U.Z)(function*(){(0,N.k_)(h);const f=d._queryInfo,p={start:d.pageSize*u,num:d.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};(0,b.pC)(d.maxRecordCountFactor)&&(p.maxRecordCountFactor=d.maxRecordCountFactor);const y=d.createTileQuery(a,p);try{const I=h.signal,v=yield d._queue.push({tile:a,query:y,signal:I,depth:u});return(0,N.k_)(h),v?f!==d._queryInfo?d._fetchDataTilePage(a,u,h):{reader:v,query:y}:null}catch(I){return(0,N.H9)(I),null}})()}}var Gs=M(4619),ks=M(52397);const js=O.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function Ws(c,a,u){const h=c.getXHydrated(),d=c.getYHydrated(),f=a.getColumnForX(h),p=Math.floor(a.normalizeCol(f));return`${u}/${Math.floor(a.getRowForY(d))}/${p}`}function kt(c,a){if((0,b.Wi)(c))return null;const u=a.transform,h=c.getQuantizationTransform();if((0,b.Wi)(h)){const[se,H]=u.scale,[re,te]=u.translate;return c.transform(-re/se,te/H,1/se,1/-H)}const[d,f]=h.scale,[p,y]=h.translate,[I,v]=u.scale,[x,T]=u.translate;return c.transform((p-x)/I,(-y+T)/v,d/I,f/v)}class Ys extends Gt{constructor(a){super(a),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new Gs.Z(1e3),this._store=a.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(a,u){super.update(a,u),this._hasAggregates=a.targets.aggregate}resend(a=!1){var u=this;return(0,U.Z)(function*(){if(yield u._downloadPromise,u._invalidated||a){const d=(0,b.s3)(u._schema.featureCount,"Expected featureCount to be defined");return u._invalidated=!1,u._subscriptions.forEach(f=>f.clear()),u._downloadPromise=u._download(d),void(yield u._downloadPromise)}const h=u._queries.map(({query:d,reader:f})=>u._sendPatchQuery(d,f));yield Promise.all(h),u._subscriptions.forEach(d=>{d.requests.done.forEach(f=>u._onMessage(f.message))})})()}refresh(){var a=this;return(0,U.Z)(function*(){yield a.resend(!0)})()}_sendPatchQuery(a,u){var h=this;return(0,U.Z)(function*(){const d=(0,b.pC)(a.outFields)?a.outFields:[],f=h._queryInfo.outFields,p=f.filter(x=>!d.includes(x));if(!p.length)return;const y=a.clone(),I=h._signal;y.returnGeometry=!1,y.returnCentroid=!1,y.outFields=p,a.outFields=f;const v=yield h._queue.push({query:y,depth:0,signal:I});(0,N.k_)({signal:I}),u.joinAttributes(v)})()}_fetchDataTile(a){var u=this;return(0,U.Z)(function*(){if(!u._downloadPromise){const v=(0,b.s3)(u._schema.featureCount,"Expected featureCount to be defined");u._downloadPromise=u._download(v)}const h=u._store.search(a),d=u._subscriptions.get(a.key.id),f=h.length-1;for(let v=0;v<f;v++){const x=kt(h[v],a),T={type:"append",id:a.id,addOrUpdate:x,end:!1,status:Ce.empty()};d.add({query:null,message:T}),u._hasAggregates||(yield(0,N.e4)(1)),u._onMessage(T)}const p=kt(f>=0?h[f]:null,a),I={type:"append",id:a.id,addOrUpdate:p,end:u._didSendEnd,status:Ce.empty()};d.add({query:null,message:I}),u._onMessage(I)})()}_download(a){var u=this;return(0,U.Z)(function*(){try{yield u.whenInitialized();const h=u._store.storage.getBitset(u._markedIdsBufId),d=new Set;h.clear();const f=Math.ceil(a/u.pageSize),p=Array.from({length:f},(y,I)=>I).sort((y,I)=>u._random.getInt()-u._random.getInt()).map(y=>u._downloadPage(y,h,d));yield Promise.all(p),u._store.sweepFeatures(h,u._store.storage),u._store.sweepFeatureSets(d)}catch(h){js.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",h)}u._sendEnd(),u._loading=!1})()}_downloadPage(a,u,h){var d=this;return(0,U.Z)(function*(){const f=d.pageSize,p={start:a*f,num:f,cacheHint:!0};(0,b.pC)(d.maxRecordCountFactor)&&(p.maxRecordCountFactor=d.maxRecordCountFactor);const y=d.createQuery(p),I=d._signal,v=yield d._queue.push({query:y,depth:a,signal:I});(0,N.k_)({signal:I}),d._queries.push({query:y,reader:v}),d._store.insert(v),h.add(v.instance);const x=v.getCursor();for(;x.next();)u.set(x.getDisplayId());d._send(v)})()}_send(a){if(!this._subscriptions.size)return;let u=null;const h=new Map,d=new Set,f=new Map;this._subscriptions.forEach(p=>{var B;const y=p.tile;h.set(y.key.id,null),u=y.tileInfoView,d.add(y.level);const{row:I,col:v}=y.key,x=`${y.level}/${I}/${v}`,T=null!=(B=f.get(x))?B:[];T.push(p),f.set(x,T)});for(const p of d){const y=u.getLODInfoAt(p),I=a.getCursor();for(;I.next();){const v=Ws(I,y,p),x=I.getIndex();if(f.has(v))for(const T of f.get(v)){const B=T.tile.id;let D=h.get(B);(0,b.Wi)(D)&&(D=[],h.set(B,D)),D.push(x)}}}h.forEach((p,y)=>{if((0,b.pC)(p)){const I=this._subscriptions.get(y),v={type:"append",id:y,addOrUpdate:kt(ks.t.from(a,p),I.tile),end:!1,status:Ce.empty()};I.add({query:null,message:v}),this._onMessage(v)}})}_sendEnd(){this._subscriptions.forEach(a=>{const u={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:Ce.empty()};a.add({query:null,message:u}),this._onMessage(u)}),this._didSendEnd=!0}}var qs=M(21286),Ee=M(39351),ge=M(99666),Qs=M(64288);M(81295),M(39406),O.Z.getLogger("esri.views.2d.engine.webgl");var ot=M(67969);const yt=O.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Rt=(yt,()=>null),At={sharedArrayBuffer:(0,F.Z)("esri-shared-array-buffer"),atomics:(0,F.Z)("esri-atomics")};function is(c,a){return u=>a(c(u))}class rr{constructor(a,u,h,d){this.size=0,this.texelSize=4;const{pixelType:f,layout:p,textureOnly:y}=d;this.textureOnly=y||!1,this.pixelType=f,this._ctype=u,this.layout=p,this._resetRange(),this._shared=a,this.size=h,y||(this.data=this._initData(f,h,a,u))}get buffer(){return(0,b.yw)(this.data,a=>a.buffer)}unsetComponentAllTexels(a,u){const h=(0,b.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)h[d*this.texelSize+a]&=~u;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(a,u){const h=(0,b.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)h[d*this.texelSize+a]|=255&u;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(a,u,h){const d=(0,b.Wg)(this.data);for(const f of h)d[f*this.texelSize+a]|=u,this.dirtyStart=Math.min(this.dirtyStart,f),this.dirtyEnd=Math.max(this.dirtyEnd,f)}setComponentTexel(a,u,h){(0,b.Wg)(this.data)[h*this.texelSize+a]|=u,this.dirtyStart=Math.min(this.dirtyStart,h),this.dirtyEnd=Math.max(this.dirtyEnd,h)}unsetComponentTexel(a,u,h){(0,b.Wg)(this.data)[h*this.texelSize+a]&=~u,this.dirtyStart=Math.min(this.dirtyStart,h),this.dirtyEnd=Math.max(this.dirtyEnd,h)}getData(a,u){const h=(0,ge.jL)(a);return(0,b.Wg)(this.data)[h*this.texelSize+u]}setData(a,u,h){const d=(0,ge.jL)(a);0!=(this.layout&1<<u)?(this.data[d*this.texelSize+u]=h,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)):yt.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===ot.Br.UNSIGNED_BYTE&&this._shared&&At.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===ot.Br.UNSIGNED_BYTE&&this._shared&&At.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(a){if(this.size=a,!this.textureOnly){const u=this._initData(this.pixelType,a,this._shared,this._ctype),h=(0,b.Wg)(this.data);u.set(h),this.data=u}}toMessage(){const a=this.dirtyStart,u=this.dirtyEnd,h=this.texelSize;if(a>u)return null;this._resetRange();const d=!(this._shared||"local"===this._ctype),f=this.pixelType,p=this.layout,y=(0,b.Wg)(this.data);return{start:a,end:u,data:d&&y.slice(a*h,(u+1)*h)||null,pixelType:f,layout:p}}_initData(a,u,h,d){const f=h&&"local"!==d?SharedArrayBuffer:ArrayBuffer,p=(0,Qs.UK)(a),y=new p(new f(u*u*4*p.BYTES_PER_ELEMENT));for(let I=0;I<y.length;I+=4)y[I+1]=255;return y}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class ir{constructor(a,u,h=(()=>{})){this._client=a,this.config=u,this._notifyChange=h,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(Ee.m4),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const d=u.supportsTextureFloat?ot.Br.FLOAT:ot.Br.UNSIGNED_BYTE;Rt(`Creating AttributeStore ${At.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:ot.Br.UNSIGNED_BYTE,layout:1},{pixelType:ot.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:ot.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){return!!this._currUpdate||!!this._nextUpdate}update(a,u){this.config=u;const h=u.schema.processors[0].storage,d=(0,Ue.Hg)(this._schema,h);if((a.targets.feature||a.targets.aggregate)&&(a.storage.data=!0),d&&((0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",d),a.storage.data=!0,this._schema=h,this._attributeComputeMap.clear(),!(0,b.Wi)(h))){switch(h.target){case"feature":this._targetType=ge.PX;break;case"aggregate":this._targetType=ge.xp}if("subtype"===h.type)for(const f in h.mapping){const p=h.mapping[f];if((0,b.pC)(p)&&(0,b.pC)(p.vvMapping))for(const y of p.vvMapping)this._bindAttribute(y)}else{if((0,b.pC)(h.vvMapping))for(const f of h.vvMapping)this._bindAttribute(f);if((0,b.pC)(h.attributeMapping))for(const f of h.attributeMapping)this._bindAttribute(f)}}}onTileData(a,u){if((0,b.Wi)(u.addOrUpdate))return;const h=u.addOrUpdate.getCursor();for(;h.next();){const d=h.getDisplayId();this.setAttributeData(d,h)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=new AbortController}setHighlight(a,u){var h=this;return(0,U.Z)(function*(){const f=h._getBlock(0),p=u.map(y=>(0,ge.jL)(y));f.lock(),f.unsetComponentAllTexels(0,1),f.setComponent(0,1,p),f.unlock(),h._idsToHighlight.clear();for(const y of a)h._idsToHighlight.add(y);yield h.sendUpdates()})()}updateFilters(a,u,h){var d=this;return(0,U.Z)(function*(){const{service:f,spatialReference:p}=h,{filters:y}=u,I=y.map((v,x)=>d._updateFilter(v,x,f,p));(yield Promise.all(I)).some(v=>v)&&(a.storage.filters=!0,(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})()}setData(a,u,h,d){const f=(0,ge.jL)(a);this._ensureSizeForTexel(f),this._getBlock(u).setData(a,h,d)}getData(a,u,h){return this._getBlock(u).getData(a,h)}getHighlightFlag(a){return this._idsToHighlight.has(a)?Ee.uG:0}unsetAttributeData(a){const u=(0,ge.jL)(a);this._getBlock(0).setData(u,0,0)}setAttributeData(a,u){const h=(0,ge.jL)(a);if(this._ensureSizeForTexel(h),this._getBlock(0).setData(h,0,this.getFilterFlags(u)),this._targetType!==(0,ge.vs)(a))return;const d=this._attributeComputeMap,f=this.config.supportsTextureFloat?1:2;d.size&&d.forEach((y,I)=>{const v=I*f%4,x=Math.floor(I*f/4),T=this._getBlock(x+Ee.aK),B=y(u);if(this.config.supportsTextureFloat)T.setData(h,v,B);else if(B===Ee.AI)T.setData(h,v,255),T.setData(h,v+1,255);else{const D=(0,qs.uZ)(Math.round(B),-32767,32766)+32768,j=(65280&D)>>8;T.setData(h,v,255&D),T.setData(h,v+1,j)}})}sendUpdates(){if((0,F.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,N.hh)(),this._nextUpdate.promise;const a={blocks:this._blocks.map(u=>(0,b.pC)(u)?u.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{const u=()=>{if(this._currUpdate=null,this._nextUpdate){const d=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>d.resolve())}else(0,F.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");this._notifyChange()};(0,F.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");const h=this._client.update(a,this._signal).then(u).catch(u);return this._client.render(this._signal),h}).catch(u=>{if((0,N.D_)(u))return this._createResourcesPromise=null,this._createResources();this._notifyChange(),yt.error(new A.Z("mapview-attribute-store","Encountered an error during client update",u))}),this._currUpdate}_ensureSizeForTexel(a){for(;a>=this._size*this._size;)if(this._expand())return}_bindAttribute(a){let d;if(null!=a.fieldIndex)d=function h(){return a.normalizationField&&yt.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),p=>p.getComputedNumericAtIndex(a.fieldIndex)}();else{if(!a.field)return;d=function u(){return a.normalizationField?p=>{const y=p.readAttribute(a.normalizationField);return y?p.readAttribute(a.field)/y:null}:p=>p.readAttribute(a.field)}()}a.valueRepresentation&&(d=is(d,p=>function $s(c,a){if(!c||!a)return c;switch(a){case"radius":case"distance":return 2*c;case"diameter":case"width":return c;case"area":return Math.sqrt(c)}return c}(p,a.valueRepresentation))),this._attributeComputeMap.set(a.binding,is(d,p=>null===p||isNaN(p)||p===1/0?Ee.AI:p))}_createResources(){if((0,b.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(Ee.xl),this._getBlock(Ee.pU),Rt("Initializing AttributeStore");const a={shared:At.sharedArrayBuffer&&"local"!==this._client.type,size:this._size,blocks:(0,b.Fd)(this._blocks,h=>({textureOnly:h.textureOnly,buffer:h.buffer,pixelType:h.pixelType}))},u=this._client.initialize(a,this._signal).catch(h=>{(0,N.D_)(h)?this._createResourcesPromise=null:yt.error(new A.Z("mapview-attribute-store","Encountered an error during client initialization",h))});return this._createResourcesPromise=u,u.then(()=>(0,b.Wi)(this._createResourcesPromise)?this._createResources():void 0),u}_getBlock(a){const u=this._blocks[a];if((0,b.pC)(u))return u;Rt(`Initializing AttributeBlock at index ${a}`);const f=new rr(At.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[a]);return this._blocks[a]=f,this._createResourcesPromise=null,f}_expand(){if(this._size<this.config.maxTextureSize){const a=this._size<<=1;return Rt("Expanding block size to",a,this._blocks),(0,b.JR)(this._blocks,u=>u.expand(a)),this._createResourcesPromise=null,this._size=a,0}return yt.error(new A.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(a,u,h,d){var f=this;return(0,U.Z)(function*(){const p=f._filters[u],y=(0,b.pC)(p)&&p.hash;if(!p&&!a||y===JSON.stringify(a))return!1;if((0,b.Wi)(a)){if(!p)return!1;const v=1<<u+1,x=f._getBlock(0);return f._filters[u]=null,x.setComponentAllTexels(0,v),f.sendUpdates(),!0}return yield(yield f._getFilter(u,h)).update(a,d),!0})()}_getFilter(a,u){var h=this;return(0,U.Z)(function*(){const d=h._filters[a];if((0,b.pC)(d))return d;const{default:f}=yield M.e(8967).then(M.bind(M,8967)),p=new f({geometryType:u.geometryType,hasM:!1,hasZ:!1,timeInfo:u.timeInfo,fieldsIndex:new _.Z(u.fields)});return h._filters[a]=p,p})()}isVisible(a){return!!(2&this._getBlock(0).getData(a,0))}getFilterFlags(a){let u=0;const h=(0,ge.KS)(a.getDisplayId());for(let f=0;f<this._filters.length;f++){const y=this._filters[f];u|=(h&1<<f&&!(0,b.Wi)(y)&&!y.check(a)?0:1)<<f}let d=0;if(this._idsToHighlight.size){const f=a.getObjectId();d=this.getHighlightFlag(f)}return u<<1|d}}function Yt(c,a,u,h){h%2&&(h+=1);let d=0,f=0,p=-90,y=90,I=-180,v=180;for(let x=0;x<h/2;x++){for(let T=0;T<5;T++){const B=(I+v)/2,D=u>B?1:0;d|=D<<29-(T+5*x),I=(1-D)*I+D*B,v=(1-D)*B+D*v}for(let T=0;T<5;T++){const B=(p+y)/2,D=a>B?1:0;f|=D<<29-(T+5*x),p=(1-D)*p+D*B,y=(1-D)*B+D*y}}c.geohashX=d,c.geohashY=f}function Ut(c,a,u,h,d){d%2&&(d+=1);let f=0,p=0,y=-90,I=90,v=-180,x=180;for(let T=0;T<d/2;T++){for(let B=0;B<5;B++){const D=(v+x)/2,Z=h>D?1:0;f|=Z<<29-(B+5*T),v=(1-Z)*v+Z*D,x=(1-Z)*D+Z*x}for(let B=0;B<5;B++){const D=(y+I)/2,Z=u>D?1:0;p|=Z<<29-(B+5*T),y=(1-Z)*y+Z*D,I=(1-Z)*D+Z*I}}c[2*a]=f,c[2*a+1]=p}M(29132),new Float64Array(2),new Float64Array(2);var qe=M(65234),Qe=M(82959);class ps{constructor(a=[],u,h=8096){this.onRelease=d=>{},this._nodes=0,this._root=new Vt(this,0,0,0),this._statisticFields=a,this._pool=h?new Et.Z(8096):null,this._serviceInfo=u}destroy(){this.clear()}_acquire(a,u,h){this._nodes++;let d=null;return(0,b.pC)(this._pool)&&(d=this._pool.dequeue()),(0,b.pC)(d)?d.realloc(a,u,h):d=new Vt(this,a,u,h),d}_release(a){this.onRelease(a),this._nodes--,(0,b.pC)(this._pool)&&this._pool.enqueue(a)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,b.R2)(this._pool,0,a=>a.size)}get depth(){let a=0;return this.forEach(u=>a=Math.max(a,u.depth)),a}dropLevels(a){this.forEach(u=>{if(u.depth>=a)for(let h=0;h<u.children.length;h++){const d=u.children[h];d&&this._release(d)}}),this.forEach(u=>{if(u.depth>=a)for(let h=0;h<u.children.length;h++)u.children[h]=null})}clear(){this.forEach(a=>this._release(a)),this._root=new Vt(this,0,0,0)}insert(a,u,h=0){const d=ie.fromOptimizedFeatures([a],this._serviceInfo).getCursor();d.next();const f=d.readGeometry();if(!f)return;const[p,y]=f.coords;this.insertCursor(d,a.displayId,p,y,a.geohashX,a.geohashY,u,h)}insertCursor(a,u,h,d,f,p,y,I=0){let v=this._root,x=0,T=0,B=0;for(;null!==v;){if(v.depth>=I&&(v.count+=1,v.xTotal+=h,v.yTotal+=d,v.xGeohashTotal+=f,v.yGeohashTotal+=p,v.referenceId=u,this._updateStatisticsCursor(a,v,1)),x>=y)return void v.add(u);const D=Math.ceil((x+1)/2),Z=Math.floor((x+1)/2),j=1-x%2,se=30-(3*D+2*Z),H=30-(2*D+3*Z),re=(f&7*j+3*(1-j)<<se)>>se,te=(p&3*j+7*(1-j)<<H)>>H,ue=re+te*(8*j+4*(1-j));T=T<<3*j+2*(1-j)|re,B=B<<2*j+3*(1-j)|te,null==v.children[ue]&&(v.children[ue]=this._acquire(T,B,x+1)),x+=1,v=v.children[ue]}}remove(a,u){const h=ie.fromOptimizedFeatures([a],this._serviceInfo).getCursor();h.next();const d=h.readGeometry();if(!d)return;const[f,p]=d.coords;this.removeCursor(h,f,p,a.geohashX,a.geohashY,u)}removeCursor(a,u,h,d,f,p){let y=this._root,I=0;for(;null!==y;){if(y.count-=1,y.xTotal-=u,y.yTotal-=h,y.xGeohashTotal-=d,y.yGeohashTotal-=f,this._updateStatisticsCursor(a,y,-1),I>=p)return void y.remove(a.getDisplayId());const v=Math.ceil((I+1)/2),x=Math.floor((I+1)/2),T=1-I%2,B=30-(3*v+2*x),D=30-(2*v+3*x),Z=((d&7*T+3*(1-T)<<B)>>B)+((f&3*T+7*(1-T)<<D)>>D)*(8*T+4*(1-T)),j=y.children[Z];1===j.count&&(this._release(j),y.children[Z]=null),I+=1,y=j}}forEach(a){let u=this._root;for(;null!==u;){const h=this._linkChildren(u)||u.next;a(u),u=h}}find(a,u,h){return this._root.find(a,u,h,0,0,0)}findIf(a){let u=null;return this.forEach(h=>{a(h)&&(u=h)}),u}findAllIf(a){const u=[];return this.forEach(h=>{a(h)&&u.push(h)}),u}findSingleOccupancyNode(a,u,h,d,f){let p=this._root;for(;null!==p;){const y=p.depth,I=p.xNode,v=p.yNode,x=1-y%2,T=p.xGeohashTotal/p.count,B=p.yGeohashTotal/p.count;if(1===p.count&&a<T&&T<=h&&u<B&&B<=d)return p;if(y>=f){p=p.next;continue}const D=Math.ceil((y+1)/2),Z=Math.floor((y+1)/2),j=30-(3*D+2*Z),se=30-(2*D+3*Z),H=~((1<<j)-1),re=~((1<<se)-1),ue=(u&re)>>se,le=(h&H)>>j,$=(d&re)>>se,fe=I<<3*x+2*(1-x),ve=v<<2*x+3*(1-x),de=fe+8*x+4*(1-x),_e=ve+4*x+8*(1-x),pe=Math.max(fe,(a&H)>>j),Re=Math.max(ve,ue),we=Math.min(de,le),Fe=Math.min(_e,$);let Se=null,Me=null;for(let Te=Re;Te<=Fe;Te++)for(let be=pe;be<=we;be++){const De=p.children[be-fe+(Te-ve)*(8*x+4*(1-x))];De&&(Se||(Se=De,Se.next=p.next),Me&&(Me.next=De),Me=De,De.next=p.next)}p=Se||p.next}return null}getRegionDisplayIds(a,u,h,d,f){let p=this._root;const y=[];for(;null!==p;){const I=p.depth,v=p.xNode,x=p.yNode;if(I>=f){const Me=p.xGeohashTotal/p.count,Te=p.yGeohashTotal/p.count;a<=Me&&Me<=h&&u<=Te&&Te<=d&&p.displayIds.forEach(be=>y.push(be)),p=p.next;continue}const T=Math.ceil((I+1)/2),B=Math.floor((I+1)/2),D=1-I%2,Z=30-(3*T+2*B),j=30-(2*T+3*B),se=~((1<<Z)-1),H=~((1<<j)-1),te=(u&H)>>j,ue=(h&se)>>Z,le=(d&H)>>j,$=v<<3*D+2*(1-D),fe=x<<2*D+3*(1-D),ve=$+8*D+4*(1-D),de=fe+4*D+8*(1-D),_e=Math.max($,(a&se)>>Z),pe=Math.max(fe,te),Re=Math.min(ve,ue),we=Math.min(de,le);let Fe=null,Se=null;for(let Me=pe;Me<=we;Me++)for(let Te=_e;Te<=Re;Te++){const ye=p.children[Te-$+(Me-fe)*(8*D+4*(1-D))];ye&&(Fe||(Fe=ye,Fe.next=p.next),Se&&(Se.next=ye),Se=ye,ye.next=p.next)}p=Fe||p.next}return y}getRegionStatistics(a,u,h,d,f){let p=this._root,y=0,I=0,v=0;const x={};let T=0;for(;null!==p;){const B=p.depth,D=p.xNode,Z=p.yNode;if(B>=f){const De=p.xGeohashTotal/p.count,Je=p.yGeohashTotal/p.count;a<De&&De<=h&&u<Je&&Je<=d&&(y+=p.count,I+=p.xTotal,v+=p.yTotal,1===p.count&&(T=p.referenceId),this._aggregateStatistics(x,p.statistics)),p=p.next;continue}const j=Math.ceil((B+1)/2),se=Math.floor((B+1)/2),H=1-B%2,re=30-(3*j+2*se),te=30-(2*j+3*se),ue=~((1<<re)-1),le=~((1<<te)-1),fe=(u&le)>>te,ve=(h&ue)>>re,de=(d&le)>>te,_e=D<<3*H+2*(1-H),pe=Z<<2*H+3*(1-H),Re=_e+8*H+4*(1-H),we=pe+4*H+8*(1-H),Fe=Math.max(_e,(a&ue)>>re),Se=Math.max(pe,fe),Me=Math.min(Re,ve),Te=Math.min(we,de);let be=null,ye=null;for(let De=Se;De<=Te;De++)for(let Je=Fe;Je<=Me;Je++){const Be=p.children[Je-_e+(De-pe)*(8*H+4*(1-H))];if(Be){if(De!==Se&&De!==Te&&Je!==Fe&&Je!==Me){const Ss=Be.xGeohashTotal/Be.count,bs=Be.yGeohashTotal/Be.count;a<Ss&&Ss<=h&&u<bs&&bs<=d&&(y+=Be.count,I+=Be.xTotal,v+=Be.yTotal,1===p.count&&(T=p.referenceId),this._aggregateStatistics(x,Be.statistics));continue}be||(be=Be,be.next=p.next),ye&&(ye.next=Be),ye=Be,Be.next=p.next}}p=be||p.next}return{count:y,attributes:this.normalizeStatistics(x,y),xTotal:I,yTotal:v,referenceId:T}}getBins(a,u,h,d,f){const p=[];let y=this._root;for(;null!==y;){const I=y.depth,v=y.xNode,x=y.yNode;if(I>=f){p.push(y),y=y.next;continue}const T=Math.ceil((I+1)/2),B=Math.floor((I+1)/2),D=1-I%2,Z=30-(3*T+2*B),j=30-(2*T+3*B),se=~((1<<Z)-1),H=~((1<<j)-1),te=(u&H)>>j,ue=(h&se)>>Z,le=(d&H)>>j,$=v<<3*D+2*(1-D),fe=x<<2*D+3*(1-D),ve=$+8*D+4*(1-D),de=fe+4*D+8*(1-D),_e=Math.max($,(a&se)>>Z),pe=Math.max(fe,te),Re=Math.min(ve,ue),we=Math.min(de,le);let Fe=null,Se=null;for(let Me=pe;Me<=we;Me++)for(let Te=_e;Te<=Re;Te++){const ye=y.children[Te-$+(Me-fe)*(8*D+4*(1-D))];ye&&(Fe||(Fe=ye,Fe.next=y.next),Se&&(Se.next=ye),Se=ye,ye.next=y.next)}y=Fe||y.next}return p}_linkChildren(a){let u=null,h=null;for(let d=0;d<=a.children.length;d++){const f=a.children[d];f&&(u||(u=f,u.next=a.next),h&&(h.next=f),h=f,f.next=a.next)}return u}_updateStatisticsCursor(a,u,h){for(const d of this._statisticFields){const f=d.name,p=d.inField?a.readAttribute(d.inField):a.getComputedNumericAtIndex(d.inFieldIndex);switch(d.statisticType){case"norm":{u.statistics[f]||(u.statistics[f]={});const I=a.readAttribute(d.inNormalizationField),v=u.statistics[f].onStatisticField||0,x=u.statistics[f].onStatisticNormalizationField||0;null==p||isNaN(p)||null==I||0===I||isNaN(I)||(u.statistics[f].onStatisticField=v+h*p,u.statistics[f].onStatisticNormalizationField=x+h*I);break}case"sum":case"avg":{u.statistics[f]||(u.statistics[f]={value:0,nanCount:0});const y=u.statistics[f].value,I=u.statistics[f].nanCount;null==p||isNaN(p)?u.statistics[f].nanCount=I+h:u.statistics[f].value=y+h*p;break}case"avg_angle":{u.statistics[f]||(u.statistics[f]={x:0,y:0,nanCount:0});const y=u.statistics[f].x,I=u.statistics[f].y,v=u.statistics[f].nanCount,x=Math.PI/180;null==p||isNaN(p)?u.statistics[f].nanCount=v+h:(u.statistics[f].x=y+h*Math.cos(p*x),u.statistics[f].y=I+h*Math.sin(p*x));break}case"mode":u.statistics[f]||(u.statistics[f]={}),u.statistics[f][p]=(u.statistics[f][p]||0)+h}}}_aggregateStatistics(a,u){for(const h of this._statisticFields){const d=h.name;switch(h.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":a[d]||(a[d]={});for(const f in u[d])a[d][f]=(a[d][f]||0)+u[d][f]}}}normalizeStatistics(a,u){const h={};for(const d of this._statisticFields){const f=d.name;switch(d.statisticType){case"norm":{const p=a[f];if(u&&null==p.onStatisticNormalizationField)break;if(u&&p.onStatisticNormalizationField){h[f]=p.onStatisticField/p.onStatisticNormalizationField;break}h[f]=0;break}case"sum":{if(!u)break;const{value:p,nanCount:y}=a[f];if(!(u-y))break;h[f]=p;break}case"avg":{if(!u)break;const{value:p,nanCount:y}=a[f];if(!(u-y))break;h[f]=p/(u-y);break}case"avg_angle":{if(!u)break;const{x:p,y,nanCount:I}=a[f];if(!(u-I))break;const T=180/Math.PI,B=Math.atan2(y/(u-I),p/(u-I))*T;h[f]=B;break}case"mode":{const p=a[f];let y=0,I=null;for(const v in p){const x=p[v];x>y&&(y=x,I=v)}h[f]="null"===I?null:I;break}}}return h}}class Vt{constructor(a,u,h,d){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=a,this.children=new Array(32);for(let f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=u,this.yNode=h,this.depth=d}realloc(a,u,h){for(let d=0;d<this.children.length;d++)this.children[d]=null;return this.xNode=a,this.yNode=u,this.depth=h,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(a){this.displayIds.add(a)}remove(a){this.displayIds.delete(a)}getAttributes(){const a=this._tree.normalizeStatistics(this.statistics,this.count);return a.aggregateId=this.id,a.aggregateCount=this.count,a}getGeometry(a,u){const h=this.getLngLatBounds(),[d,f,p,y]=h,I=(0,Qe.iV)({rings:[[[d,f],[d,y],[p,y],[p,f],[d,f]]]},qe.Z.WGS84,a),v=(0,E.Uy)(new oe.Z,I,!1,!1);return(0,b.pC)(u)?(0,E.Nh)(new oe.Z,v,!1,!1,"esriGeometryPolygon",u,!1,!1):v}getLngLatBounds(){const a=this.depth,u=Math.ceil(a/2),h=Math.floor(a/2);return function ar(c,a){let u=-90,h=90,d=-180,f=180;for(let p=0;p<a;p++){const y=Math.ceil((p+1)/2),I=Math.floor((p+1)/2),v=1-p%2,x=30-(3*y+2*I),T=30-(2*y+3*I),D=2*v+3*(1-v),j=(7*v+3*(1-v)<<x&c.geohashX)>>x,se=(3*v+7*(1-v)<<T&c.geohashY)>>T;for(let H=3*v+2*(1-v)-1;H>=0;H--){const re=(d+f)/2,te=j&1<<H?1:0;d=(1-te)*d+te*re,f=(1-te)*re+te*f}for(let H=D-1;H>=0;H--){const re=(u+h)/2,te=se&1<<H?1:0;u=(1-te)*u+te*re,h=(1-te)*re+te*h}}return[d,u,f,h]}({geohashX:this.xNode<<30-(3*u+2*h),geohashY:this.yNode<<30-(2*u+3*h)},this.depth)}find(a,u,h,d,f,p){if(d>=h)return this;const y=1-d%2,I=3*y+2*(1-y),v=2*y+3*(1-y),x=30-f-I,T=30-p-v,D=this.children[((a&7*y+3*(1-y)<<x)>>x)+((u&3*y+7*(1-y)<<T)>>T)*(8*y+4*(1-y))];return null==D?null:D.find(a,u,h,d+1,f+I,p+v)}}var He=M(94425),_s=M(16669),dr=M(37118),cr=M(2004);const qt=O.Z.getLogger("esri.view.2d.layers.features.support.BinStore");function ys(c){return 57.29577951308232*c}class pr extends _s.J{constructor(a,u,h,d){super(a,h),this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=u,this._projectionSupportCheck=(0,Qe._W)(u,qe.Z.WGS84),this._bitsets.geohash=h.getBitset(h.createBitset()),this._bitsets.inserted=h.getBitset(h.createBitset())}destroy(){this._tree&&this._tree.destroy()}updateSchema(a,u){var h=()=>super.updateSchema,d=this;return(0,U.Z)(function*(){const f=d._schema;try{yield h().call(d,a,u),yield d._projectionSupportCheck}catch(y){}const p=(0,Ue.Hg)(f,u);u&&(!(0,b.Wi)(p)||a.source||a.storage.filters)?(((0,Ue.uD)(p,"params.fields")||(0,Ue.uD)(p,"params")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new ps(d._statisticFields,d._serviceInfo),d._tree.onRelease=y=>y.displayId&&d._storage.releaseDisplayId(y.displayId),d._geohashLevel=d._schema.params.fixedBinLevel,d._rebuildTree(),(0,F.Z)("esri-2d-update-debug")&&qt.info("Aggregate mesh needs update due to tree changing")),(0,F.Z)("esri-2d-update-debug")&&qt.info("Aggregate mesh needs update due to tree changing"),a.targets[u.name]=!0,a.mesh=!1):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,u){this._bitsets.inserted.forEachSet(h=>{if(!a.has(h)){const d=u.lookupByDisplayIdUnsafe(h);this._remove(d)}})}sweepAggregates(a,u,h){}onTileData(a,u,h,d,f=!0){if(!this._schema||(0,b.Wi)(u.addOrUpdate))return u;const p=this._getTransforms(a,this._spatialReference);{const I=u.addOrUpdate.getCursor();for(;I.next();)this._update(I,d)}if(u.status.mesh||!f)return u;const y=new Array;this._getBinsForTile(y,a,p,h),u.addOrUpdate=ie.fromOptimizedFeatures(y,Ae(me({},this._serviceInfo),{geometryType:"esriGeometryPolygon"})),u.addOrUpdate.attachStorage(h),u.clear=!0,u.end=!0;{const I=u.addOrUpdate.getCursor();for(;I.next();){const v=I.getDisplayId();this._bitsets.computed.unset(v),this.setComputedAttributes(h,I,v,a.scale)}}return u}forEach(a){this._tree.forEach(a)}onTileUpdate(a){}getAggregate(a){const u=(0,ge.QS)(a,!0),h=this._tree.findIf(d=>d.displayId===u);return(0,b.yw)(h,d=>this._toAggregateGraphic(d))}getAggregates(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toAggregateGraphic.bind(this))}getDisplayId(a){const u=this._tree.findIf(h=>h.id===a);return(0,b.yw)(u,h=>h.displayId)}getFeatureDisplayIdsForAggregate(a){const u=this._tree.findIf(h=>h.id===a);return(0,b.R2)(u,[],h=>Array.from(h.displayIds))}getDisplayIdForReferenceId(a){const u=this._tree.findIf(h=>1===h.displayIds.size&&h.displayIds.has(a));return(0,b.yw)(u,h=>h.displayId)}_toAggregateGraphic(a){const u=this._spatialReference;return{referenceId:null,objectId:a.id,displayId:a.displayId,attributes:a.getAttributes(),geometry:(0,E.di)(a.getGeometry(u),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const u=a.getDisplayId(),h=a.getXHydrated(),d=a.getYHydrated(),f=this._geohashBuf[2*u],p=this._geohashBuf[2*u+1];this._bitsets.inserted.has(u)&&(this._bitsets.inserted.unset(u),this._tree.removeCursor(a,h,d,f,p,this._geohashLevel))}_update(a,u){const h=a.getDisplayId(),d=this._bitsets.inserted,f=u.isVisible(h);if(f===d.has(h))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),y=a.getYHydrated();this._setGeohash(h,p,y)&&(this._tree.insertCursor(a,h,p,y,this._geohashBuf[2*h],this._geohashBuf[2*h+1],this._geohashLevel),d.set(h))}_setGeohash(a,u,h){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=ys(u/He.sv.radius),p=f-360*Math.floor((f+180)/360);Ut(d,a,ys(Math.PI/2-2*Math.atan(Math.exp(-h/He.sv.radius))),p,12)}else{const f=(0,Qe.iV)({x:u,y:h},this._spatialReference,qe.Z.WGS84);if(!f)return!1;Ut(d,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getBinsForTile(a,u,h,d){try{const{xLL:f,yLL:p,xTR:y,yTR:I,level:v}=this._getGeohashBounds(u),x=this._tree.getBins(f,p,y,I,v);for(const T of x){T.displayId||(T.displayId=d.createDisplayId(!0));const B=T.getGeometry(this._spatialReference,h.tile),D=new G.u_(B,T.getAttributes());D.objectId=T.id,D.displayId=T.displayId,a.push(D)}}catch(f){return void qt.error("Unable to get bins for tile",u.key.id)}}_getGeohash(a,u,h){const d={geohashX:0,geohashY:0};return Yt(d,u,a,h),d}_getGeohashBounds(a){const u=this._getGeohashLevel(a.key.level),d=dr.Z.fromExtent(cr.Z.fromBounds([a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],this._spatialReference)),f=(0,Qe.iV)(d,this._spatialReference,qe.Z.WGS84,{densificationStep:64*a.resolution}),p=(0,E.Uy)(new oe.Z,f,!1,!1),y=p.coords.filter((j,se)=>!(se%2)),I=p.coords.filter((j,se)=>se%2),v=Math.min(...y),x=Math.min(...I),T=Math.max(...y),B=Math.max(...I),D=this._getGeohash(v,x,u),Z=this._getGeohash(T,B,u);return{xLL:D.geohashX,yLL:D.geohashY,xTR:Z.geohashX,yTR:Z.geohashY,level:u}}_getGeohashLevel(a){return this._schema.params.fixedBinLevel}_getTransforms(a,u){const h={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,ee.C5)(u);if(!d)return{tile:h,left:null,right:null};const[f,p]=d.valid;return{tile:h,left:Ae(me({},h),{translate:[p,a.bounds[3]]}),right:Ae(me({},h),{translate:[f-p+a.bounds[0],a.bounds[3]]})}}}class Ht extends G.nd{constructor(a,u,h,d,f){super(new oe.Z([],[u,h]),d,null,a),this.geohashBoundsInfo=f}get count(){return this.attributes.cluster_count}static create(a,u,h,d,f,p,y,I){const v=new Ht(u,h,d,p,y);return v.displayId=a.createDisplayId(!0),v.referenceId=I,v.tileLevel=f,v}update(a,u,h,d,f,p){return this.geometry.coords[0]=a,this.geometry.coords[1]=u,this.tileLevel=h,this.attributes=d,this.geohashBoundsInfo=f,this.referenceId=null,this.referenceId=p,this}toJSON(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:Ae(me({},this.attributes),{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function xt(c){return 57.29577951308232*c}class _r extends _s.J{constructor(a,u,h,d){super(a,h),this.events=new Tt.Z,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=u,this._projectionSupportCheck=(0,Qe._W)(u,qe.Z.WGS84),this._bitsets.geohash=h.getBitset(h.createBitset()),this._bitsets.inserted=h.getBitset(h.createBitset())}destroy(){this._tree.destroy()}updateSchema(a,u){var h=()=>super.updateSchema,d=this;return(0,U.Z)(function*(){const f=d._schema;try{yield h().call(d,a,u),yield d._projectionSupportCheck}catch(y){}const p=(0,Ue.Hg)(f,u);u&&(!(0,b.Wi)(p)||a.source||a.storage.filters)?(((0,Ue.uD)(p,"params.fields")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new ps(d._statisticFields,d._serviceInfo),d._rebuildTree(),(0,F.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",p),a.targets[u.name]=!0,a.mesh=!1,d._aggregateValueRanges={}):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,u){this._bitsets.inserted.forEachSet(h=>{if(!a.has(h)){const d=u.lookupByDisplayIdUnsafe(h);this._remove(d)}})}sweepAggregates(a,u,h){this._clusters.forEach((d,f)=>{d&&d.tileLevel!==h&&(a.releaseDisplayId(d.displayId),u.unsetAttributeData(d.displayId),this._clusters.delete(f))})}onTileData(a,u,h,d,f=!0){if(!this._schema||(0,b.Wi)(u.addOrUpdate))return u;const p=this._getTransforms(a,this._spatialReference);{const v=u.addOrUpdate.getCursor();for(;v.next();)this._update(v,d)}if(u.status.mesh||!f)return u;const y=new Array;this._getClustersForTile(y,a,this._schema.params.clusterRadius,h,p),u.addOrUpdate=ie.fromOptimizedFeatures(y,this._serviceInfo),u.addOrUpdate.attachStorage(h),u.clear=!0,u.end=!0;{const v=u.addOrUpdate.getCursor();for(;v.next();){const x=v.getDisplayId();this._bitsets.computed.unset(x),this.setComputedAttributes(h,v,x,a.scale)}}return this._aggregateValueRangesChanged&&u.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),u}onTileUpdate({added:a,removed:u}){if(a.length){const d=a[0].level;this._tileLevel=d,this._setGeohashLevel(d)}if(!this._schema)return;const h=this._schema.params.clusterRadius;u.forEach(d=>{this._tiles.delete(d.key.id),this._markTileClustersForDeletion(d,h)})}getAggregate(a){for(const u of this._clusters.values())if(((null==u?void 0:u.displayId)&ge._I)==(a&ge._I))return u.toJSON();return null}getAggregates(){const a=[];for(const u of this._clusters.values())(null==u?void 0:u.tileLevel)===this._tileLevel&&a.push(u.toJSON());return a}getDisplayId(a){const u=this._clusters.get(a);return u?u.displayId:null}getFeatureDisplayIdsForAggregate(a){const u=this._clusters.get(a);if(!u)return[];const h=u.geohashBoundsInfo;return this._tree.getRegionDisplayIds(h.xLL,h.yLL,h.xTR,h.yTR,h.level)}getDisplayIdForReferenceId(a){for(const u of this._clusters.values())if((null==u?void 0:u.referenceId)===a)return u.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(a){for(const[u,h]of this._clusters)h&&a(h,u)}size(){let a=0;return this.forEach(u=>a++),a}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const u=a.getDisplayId(),h=a.getXHydrated(),d=a.getYHydrated(),f=this._geohashBuf[2*u],p=this._geohashBuf[2*u+1];this._bitsets.inserted.has(u)&&(this._bitsets.inserted.unset(u),this._tree.removeCursor(a,h,d,f,p,this._geohashLevel))}_update(a,u){const h=a.getDisplayId(),d=this._bitsets.inserted,f=u.isVisible(h);if(f===d.has(h))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),y=a.getYHydrated();this._setGeohash(h,p,y)&&(this._tree.insertCursor(a,h,p,y,this._geohashBuf[2*h],this._geohashBuf[2*h+1],this._geohashLevel),d.set(h))}_setGeohash(a,u,h){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=xt(u/He.sv.radius),p=f-360*Math.floor((f+180)/360);Ut(d,a,xt(Math.PI/2-2*Math.atan(Math.exp(-h/He.sv.radius))),p,12)}else{const f=(0,Qe.iV)({x:u,y:h},this._spatialReference,qe.Z.WGS84);if(!f)return!1;Ut(d,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getClustersForTile(a,u,h,d,f,p=!0){const y=this._schema.params.clusterPixelBuffer,I=2*h,v=this._getGeohashLevel(u.key.level),x=Math.ceil(2**u.key.level*Ee.I_/I),T=Math.ceil(y/I)+0,B=Math.ceil(Ee.I_/I),{row:D,col:Z}=u.key,se=D*Ee.I_,H=Math.floor(Z*Ee.I_/I)-T,re=Math.floor(se/I)-T,te=H+B+2*T,ue=re+B+2*T,le=u.tileInfoView.getLODInfoAt(u.key.level);for(let $=H;$<=te;$++)for(let fe=re;fe<=ue;fe++){let ve=$;le.wrap&&(ve=$<0?$+x:$%x);const de=le.wrap&&$<0,_e=le.wrap&&$%x!==$,pe=this._lookupCluster(d,le,u.key.level,ve,fe,v);if((0,b.pC)(pe)){const Re=(0,b.yw)(f,we=>de?we.left:_e?we.right:we.tile);if(p&&(0,b.Wi)(Re)||!pe.count)continue;if((0,b.pC)(Re)&&p){const we=pe.geometry.clone();let Fe=pe.attributes;we.coords[0]=(0,E.Jd)(Re,we.coords[0]),we.coords[1]=(0,E.IN)(Re,we.coords[1]),1===pe.count&&(0,b.pC)(pe.referenceId)&&(Fe=Ae(me({},pe.attributes),{referenceId:pe.referenceId}));const Se=new G.u_(we,Fe);Se.displayId=pe.displayId,a.push(Se)}}}}_getGeohashLevel(a){return Math.min(Math.ceil(a/2+2),12)}_setGeohashLevel(a){const u=this._getGeohashLevel(a),h=1*(Math.floor(u/1)+1)-1;if(this._geohashLevel!==h)return this._geohashLevel=h,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(a,u){const h={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,ee.C5)(u);if(!d)return{tile:h,left:null,right:null};const[f,p]=d.valid;return{tile:h,left:Ae(me({},h),{translate:[p,a.bounds[3]]}),right:Ae(me({},h),{translate:[f-p+a.bounds[0],a.bounds[3]]})}}_getClusterId(a,u,h){return(15&a)<<28|(16383&u)<<14|16383&h}_markForDeletion(a,u,h){const d=this._getClusterId(a,u,h);this._clusters.delete(d)}_getClusterBounds(a,u,h){const d=this._schema.params.clusterRadius,f=2*d;let p=h%2?u*f:u*f-d;const y=h*f;let I=p+f;const x=2**a.level*Ee.I_;a.wrap&&p<0&&(p=0),a.wrap&&I>x&&(I=x);const B=y/Ee.I_,D=I/Ee.I_,Z=(y-f)/Ee.I_;return[a.getXForColumn(p/Ee.I_),a.getYForRow(B),a.getXForColumn(D),a.getYForRow(Z)]}_lookupCluster(a,u,h,d,f,p){const y=this._getClusterId(h,d,f),I=this._clusters.get(y),[v,x,T,B]=this._getClusterBounds(u,d,f),D={x:v,y:x},Z={x:T,y:B};let j=0,se=0,H=0,re=0;if(this._spatialReference.isWebMercator){{const ye=xt(D.x/He.sv.radius);j=ye-360*Math.floor((ye+180)/360),se=xt(Math.PI/2-2*Math.atan(Math.exp(-D.y/He.sv.radius)))}{const ye=xt(Z.x/He.sv.radius);H=ye-360*Math.floor((ye+180)/360),re=xt(Math.PI/2-2*Math.atan(Math.exp(-Z.y/He.sv.radius)))}}else{const ye=(0,Qe.iV)(D,this._spatialReference,qe.Z.WGS84),De=(0,Qe.iV)(Z,this._spatialReference,qe.Z.WGS84);if(!ye||!De)return null;j=ye.x,se=ye.y,H=De.x,re=De.y}const te={geohashX:0,geohashY:0},ue={geohashX:0,geohashY:0};Yt(te,se,j,p),Yt(ue,re,H,p);const le=te.geohashX,$=te.geohashY,fe=ue.geohashX,ve=ue.geohashY,de={xLL:le,yLL:$,xTR:fe,yTR:ve,level:p},_e=this._tree.getRegionStatistics(le,$,fe,ve,p),{count:pe,xTotal:Re,yTotal:we,referenceId:Fe}=_e,Se=pe?Re/pe:0,Me=pe?we/pe:0;if(0===pe)return this._clusters.set(y,null),null;const Te=me({cluster_count:pe},_e.attributes),be=(0,b.pC)(I)?I.update(Se,Me,h,Te,de,Fe):Ht.create(a,y,Se,Me,h,Te,de,Fe);return 0===pe&&(be.geometry.coords[0]=(v+T)/2,be.geometry.coords[1]=(x+B)/2),this._clusters.set(y,be),this._updateAggregateValueRangeForCluster(be,be.tileLevel),be}_updateAggregateValueRangeForCluster(a,u){const h=this._aggregateValueRanges[u]||{minValue:1/0,maxValue:0},d=h.minValue,f=h.maxValue;h.minValue=Math.min(d,a.count),h.maxValue=Math.max(f,a.count),this._aggregateValueRanges[u]=h,d===h.minValue&&f===h.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(a,u){const h=2*u,d=Math.ceil(Ee.I_/h),{row:f,col:p}=a.key,I=f*Ee.I_,v=Math.floor(p*Ee.I_/h),x=Math.floor(I/h);for(let T=v;T<v+d;T++)for(let B=x;B<x+d;B++)this._markForDeletion(a.key.level,T,B)}}class mr{constructor(){this._freeIds=[],this._idCounter=1}createId(a=!1){return(0,ge.QS)(this._getFreeId(),a)}releaseId(a){this._freeIds.push(a)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}var yr=M(42797);function Pt(c,a,u){if(!(c.length>a))for(;c.length<=a;)c.push(u)}class Ir{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new mr,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const a=this._bitsets.length;return this._bitsets.push(yr.p.create(this._allocatedSize,ge._I)),a+1}getBitset(a){return this._bitsets[a-1]}_expand(){this._allocatedSize<<=1;for(const a of this._bitsets)a.resize(this._allocatedSize)}_ensureNumeric(a,u){this._numerics[a]||(this._numerics[a]=[]),Pt(this._numerics[a],u,0)}_ensureInstanceId(a){Pt(this._instanceIds,a,0)}_ensureString(a,u){this._strings[a]||(this._strings[a]=[]),Pt(this._strings[a],u,null)}createDisplayId(a=!1){const u=this._idGenerator.createId();return u>this._allocatedSize&&this._expand(),(0,ge.QS)(u,a)}releaseDisplayId(a){for(const u of this._bitsets)u.unset(a);return this._idGenerator.releaseId(a&ge._I)}getComputedNumeric(a,u){return this.getComputedNumericAtIndex(a&ge._I,0)}setComputedNumeric(a,u,h){return this.setComputedNumericAtIndex(a&ge._I,h,0)}getComputedString(a,u){return this.getComputedStringAtIndex(a&ge._I,0)}setComputedString(a,u,h){return this.setComputedStringAtIndex(a&ge._I,0,h)}getComputedNumericAtIndex(a,u){const h=a&ge._I;return this._ensureNumeric(u,h),this._numerics[u][h]}setComputedNumericAtIndex(a,u,h){const d=a&ge._I;this._ensureNumeric(u,d),this._numerics[u][d]=h}getInstanceId(a){const u=a&ge._I;return this._ensureInstanceId(u),this._instanceIds[u]}setInstanceId(a,u){const h=a&ge._I;this._ensureInstanceId(h),this._instanceIds[h]=u}getComputedStringAtIndex(a,u){const h=a&ge._I;return this._ensureString(u,h),this._strings[u][h]}setComputedStringAtIndex(a,u,h){const d=a&ge._I;this._ensureString(u,d),this._strings[u][d]=h}getXMin(a){return this._bounds[4*(a&ge._I)]}getYMin(a){return this._bounds[4*(a&ge._I)+1]}getXMax(a){return this._bounds[4*(a&ge._I)+2]}getYMax(a){return this._bounds[4*(a&ge._I)+3]}setBounds(a,u){const h=u.readHydratedGeometry();if(!h||!h.coords.length)return!1;let d=1/0,f=1/0,p=-1/0,y=-1/0;h.forEachVertex((v,x)=>{d=Math.min(d,v),f=Math.min(f,x),p=Math.max(p,v),y=Math.max(y,x)});const I=a&ge._I;return Pt(this._bounds,4*I+4,0),this._bounds[4*I]=d,this._bounds[4*I+1]=f,this._bounds[4*I+2]=p,this._bounds[4*I+3]=y,!0}}function Ke(c){if(!(0,N.D_)(c)&&!function Cr(c){return"worker:port-closed"===c.name}(c))throw c}function vs(c){return"feature"===c.type&&"snapshot"===c.mode}let Oe=class extends k.r{constructor(){super(...arguments),this._storage=new Ir,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new Nt.e({concurrency:"geoevent"===this._source.type?1:4,process:(c,a)=>this._onTileMessage(c,{signal:a})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,L.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function Xs(c,a,u,h,d,f){const p=function Vs(c,a,u,h,d,f){switch(c.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,b.Pt)(c.featureCount,0),serviceInfo:c,onMessage:h,outSR:a,tileInfoView:u,canAcceptRequest:d,store:f};case"stream":return{type:"geoevent",serviceInfo:c,onMessage:h,outSR:a,canAcceptRequest:d};case"memory":case"on-demand":return{type:"feature",serviceInfo:c,onMessage:h,outSR:a,origin:function p(y){return Array.isArray(y)?"local":"path"in y&&(0,S.M8)(y.path)?"hosted":"unknown"}(c.source),tileInfoView:u,canAcceptRequest:d}}}(c,a,u,h,d,f);switch(p.type){case"feature":switch(p.origin){case"hosted":case"local":return new Ns(p);case"snapshot":return new Ys(p);case"unknown":return new As(p)}case"geoevent":return new zs(p)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(h,d)=>(this._invalidated=!0,this._patchTile(h,d)),()=>this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("geoevent"===this._source.type){const c=this._source.events;this.handles.add([c.on("connectionStatus",a=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:a}).catch(Ke)),c.on("errorString",a=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:a}).catch(Ke)),c.on("feature",a=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry}}).catch(Ke)),c.on("updateRate",a=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:me({},a)}).catch(Ke))])}}_initAttributeStore(c){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new ir({type:"remote",initialize:(a,u)=>(0,N.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",a,{signal:u}).catch(Ke)),update:(a,u)=>(0,N.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",a,{signal:u}).catch(Ke)),render:a=>(0,N.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:a}).catch(Ke))},c,()=>this.notifyChange("updating"))}_initStores(){this.featureStore=new m.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(c){var u;const a=this;null==(u=this.queryEngine)||u.destroy(),this.queryEngine=new P.q({definitionExpression:c.schema.source.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:h=>(0,b.Wi)(a.aggregateStore)?[]:a.aggregateStore.getFeatureDisplayIdsForAggregate(h).map(d=>a.getObjectId(d))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy();for(const c of this.tileStore.tiles)this._source.unsubscribe(c);clearInterval(this._checkUpdating)}get fieldsIndex(){return new _.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const c=this._source.updating,a=!!this._updateQueue.length,u=!this.attributeStore||this.attributeStore.isUpdating(),h=c||a||u;return(0,F.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${h}\n  -> updatingSource ${c}\n  -> updateQueue ${a}\n  -> updatingAttributeStore ${u}\n`),h}enableEvent(c){this._source.enableEvent(c.name,c.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"geoevent"===this._source.type&&this._source.pauseStream()}resumeStream(){"geoevent"===this._source.type&&this._source.resumeStream()}_initAggregateStore(c){var d,f;const a={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},u=null==(f=null==(d=c.schema.targets)?void 0:d.aggregate)?void 0:f.type;if((0,b.yw)(this.config,p=>{var y,I;return null==(I=null==(y=p.schema.targets)?void 0:y.aggregate)?void 0:I.type})!==u&&((0,b.pC)(this.aggregateStore)&&(this.handles.remove("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),u)){switch(u){case"cluster":this.aggregateStore=new _r(a,this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",p=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:p.valueRanges}}).catch(Ke)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new pr(a,this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(c,a){var u=this;return(0,U.Z)(function*(){u._updateVersion++,u._initQueryEngine(a),u._initAttributeStore(a),u.pause(),yield Promise.all([u._source.update(c,a.schema.source),u.featureStore.updateSchema(c,a.schema.targets.feature),u.attributeStore.update(c,a),u.attributeStore.updateFilters(c,a,u)]),u._initAggregateStore(a),(0,b.pC)(u.aggregateStore)&&(yield u.aggregateStore.updateSchema(c,a.schema.targets.aggregate)),(0,F.Z)("esri-2d-update-debug")&&c.describe(),u._set("config",a)})()}applyUpdate(c){var a=this;return(0,U.Z)(function*(){c.version=a._updateVersion,(0,F.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${c.version}`),c.mesh&&a.clearTiles(),a._updateQueue.resume(),yield a._source.applyUpdate(c),a.notifyChange("updating"),yield(0,L.N1)(()=>!a.updating),(0,b.pC)(a.aggregateStore)&&(yield(0,N.e4)(10),yield(0,L.N1)(()=>!a.updating))})()}onEdits({edits:c}){var a=this;return(0,U.Z)(function*(){(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",c),a._didEdit=!0;try{const u=c.removed.map(d=>d.objectId&&-1!==d.objectId?d.objectId:a._lookupObjectIdByGlobalId(d.globalId)),h=c.addOrModified.map(({objectId:d})=>d);a.featureStore.invalidate(),yield a._source.edit(h,u),a.clearTiles(),a.notifyChange("updating"),(0,b.pC)(a.aggregateStore)&&a.aggregateStore.clear(),yield a._source.resend(),yield(0,L.N1)(()=>!a.updating)}catch(u){}})()}refresh(c){var a=this;return(0,U.Z)(function*(){if(!c){const u=Ce.empty();return u.storage.filters=!0,a.applyUpdate(u)}a.featureStore.invalidate(),a.clearTiles(),a._source.refresh(a._updateVersion),a._cleanupNeeded=!0,a.notifyChange("updating"),yield(0,L.N1)(()=>!a.updating)})()}clearTiles(){for(const c of this.tileStore.tiles)this.processor.onTileClear(c)}onTileUpdate(c){(0,b.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(c);for(const a of c.added)this._source.subscribe(a,this._updateVersion),this._level=a.level;for(const a of c.removed)this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id));this.notifyChange("updating")}onIdle(){var c=this;return(0,U.Z)(function*(){c._invalidated&&(c._invalidated=!1,((0,b.pC)(c.aggregateStore)||"heatmap"===c.processor.type)&&(yield c._repushCurrentLevelTiles())),c._markAndSweep()})()}querySummaryStatistics({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForSummaryStatistics(c,a)})()}queryUniqueValues({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForUniqueValues(c,a)})()}queryClassBreaks({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForClassBreaks(c,a)})()}queryHistogram({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForHistogram(c,a)})()}queryExtent(c){return this.queryEngine.executeQueryForExtent(c)}queryFeatures(c){return this.queryEngine.executeQuery(c)}queryVisibleFeatures(c){var a=this;return(0,U.Z)(function*(){const u=yield a.queryEngine.executeQuery(c),h=u.objectIdFieldName;return u.features=u.features.filter(d=>{const p=a.getDisplayId(d.attributes[h]);return(0,b.yw)(p,y=>a.attributeStore.isVisible(y))}),u})()}queryFeatureCount(c){return this.queryEngine.executeQueryForCount(c)}queryLatestObservations(c){return this.queryEngine.executeQueryForLatestObservations(c)}queryObjectIds(c){return this.queryEngine.executeQueryForIds(c)}queryStatistics(){var c=this;return(0,U.Z)(function*(){return c.featureStore.storeStatistics})()}getObjectId(c){return this.featureStore.lookupObjectId(c,this._storage)}getDisplayId(c){if((0,b.pC)(this.aggregateStore)){const a=this.aggregateStore.getDisplayId(c);if((0,b.Wi)(a)){const u=this.featureStore.lookupDisplayId(c);return this.aggregateStore.getDisplayIdForReferenceId(u)}return a}return this.featureStore.lookupDisplayId(c)}getFeatures(c){const a=[],u=[];for(const h of c){const d=(0,b.pC)(this.aggregateStore)?this.getAggregate(h):null;if((0,b.pC)(d))if((0,b.pC)(d.referenceId)){const f=this.getFeature(d.referenceId);(0,b.pC)(f)&&a.push(f)}else u.push(d);else{const f=this.getFeature(h);(0,b.pC)(f)&&a.push(f)}}return{features:a,aggregates:u}}getFeature(c){const a=this.featureStore.lookupFeatureByDisplayId(c,this._storage);if((0,b.Wi)(a))return null;const u=a.readHydratedGeometry(),h=(0,E.di)(u,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),geometry:h}}getAggregate(c){return(0,b.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(c)}getAggregates(){return(0,b.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(c){var a=this;return(0,U.Z)(function*(){const u=(0,b.lV)(c.map(h=>a.getDisplayId(h)));return a.attributeStore.setHighlight(c,u)})()}_lookupObjectIdByGlobalId(c){const a=this.service.globalIdField;if((0,b.Wi)(a))throw new Error("Expected globalIdField to be defined");let u=null;if(this.featureStore.forEach(h=>{c===h.readAttribute(a)&&(u=h.getObjectId())}),(0,b.Wi)(u))throw new Error(`Expected to find a feature with globalId ${c}`);return u}_repushCurrentLevelTiles(){var c=this;return(0,U.Z)(function*(){const a=c.tileStore.tiles.filter(u=>u.level===c._level).map(function(){var u=(0,U.Z)(function*(h){return c._patchTile({type:"append",id:h.key.id,addOrUpdate:ie.fromOptimizedFeatures([],c.service),remove:[],end:!0,status:Ce.empty()})});return function(h){return u.apply(this,arguments)}}());yield Promise.all(a)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(c,a){const u=this._updateQueue.push(c,a).then(()=>{this.notifyChange("updating")}).catch(h=>{this.notifyChange("updating")});return this.notifyChange("updating"),u}_onTileMessage(c,a){var u=this;return(0,U.Z)(function*(){(0,N.k_)(a);const h=u.tileStore.get(c.id);if(!h)return;if(c.clear)return u.processor.onTileClear(h);const d=c.status;u._cleanupNeeded=!0;const f=[];for(const p of c.remove){const y=u.featureStore.lookupDisplayId(p);y&&f.push(y)}c.remove=f;try{if((0,b.Wi)(c.addOrUpdate))return void u.processor.onTileMessage(h,Ae(me({},c),{addOrUpdate:null}),(0,b.pC)(u.aggregateStore),a).catch(N.H9);if(c.addOrUpdate.setArcadeSpatialReference(u.spatialReference),u.featureStore.hasInstance(c.addOrUpdate.instance)&&d.targets.feature||(d.targets.feature=!0,u.featureStore.onTileData(h,c)),(!d.storage.data||!d.storage.filters)&&(d.storage.data=!0,d.storage.filters=!0,u.attributeStore.onTileData(h,c),"geoevent"===u._source.type||u._didEdit?(yield u.attributeStore.sendUpdates(),(0,N.k_)(a)):u.attributeStore.sendUpdates()),(0,b.pC)(u.aggregateStore)&&!d.targets.aggregate){d.targets.aggregate=!0;const p=vs(u._source)&&u._source.loading,y=!vs(u._source)||p||c.end;if(u.aggregateStore.onTileData(h,c,u._storage,u.attributeStore,y),!y)return;d.mesh||(u.attributeStore.onTileData(h,c),yield u.attributeStore.sendUpdates())}d.mesh||(d.mesh=!0,yield u.processor.onTileMessage(h,c,(0,b.pC)(u.aggregateStore),a),(0,N.k_)(a)),u._maybeForceCleanup()}catch(p){(0,N.H9)(p)}})()}_mark(c,a,u){const h=(4294901760&this._storage.getInstanceId(c))>>>16;c&&(a.add(h),u.set(c))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const c=this._storage.getBitset(this._markedIdsBufId),a=new Set;c.clear();for(const u of this.tileStore.tiles)for(const h of this._source.readers(u.id)){const d=h.getCursor();for(;d.next();){let f=d.getDisplayId();if(!f){const p=d.getObjectId();f=this.featureStore.lookupDisplayId(p)}this._mark(f,a,c)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(u=>{this._mark(u,a,c)}),this._updateQueue.forEach(u=>{for(const h of u.remove){const d=this.featureStore.lookupDisplayId(h);this._mark(d,a,c)}}),(0,b.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(c,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(c,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(a)}};(0,K._)([(0,X.Cb)({constructOnly:!0})],Oe.prototype,"tileStore",void 0),(0,K._)([(0,X.Cb)()],Oe.prototype,"config",void 0),(0,K._)([(0,X.Cb)({readOnly:!0})],Oe.prototype,"fieldsIndex",null),(0,K._)([(0,X.Cb)()],Oe.prototype,"processor",void 0),(0,K._)([(0,X.Cb)({constructOnly:!0})],Oe.prototype,"remoteClient",void 0),(0,K._)([(0,X.Cb)({constructOnly:!0})],Oe.prototype,"service",void 0),(0,K._)([(0,X.Cb)()],Oe.prototype,"spatialReference",null),(0,K._)([(0,X.Cb)()],Oe.prototype,"updating",null),Oe=(0,K._)([(0,V.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],Oe);const Fr=Oe;var xs=M(81340),Mr=M(84378),Tr=M(58098);const at={added:[],removed:[]},Kt=new Set,Ar=new Tr.Z(0,0,0,0);class Er extends Tt.Z{constructor(a){super(),this._tiles=new Map,this._index=(0,es.r)(9,(0,F.Z)("esri-csp-restrictions")?u=>({minX:u.bounds[0],minY:u.bounds[1],maxX:u.bounds[2],maxY:u.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const u={added:[],removed:[]};for(const h of a.added)if(!this.has(h)){const d=new xs.n(this.tileScheme,h);this._tiles.set(h,d),this._index.insert(d),u.added.push(d)}for(const h of a.removed)if(this.has(h)){const d=this.get(h);this._tiles.delete(h),this._index.remove(d),u.removed.push(d)}this.tiles.length=0,this._tiles.forEach(h=>this.tiles.push(h)),(u.added.length||u.removed.length)&&this.emit("update",u)}setViewState(a){const u=this.tileScheme.getTileCoverage(a,0);if(!u)return;const{spans:h,lodInfo:d}=u,{level:f}=d;if(h.length>0)for(const{row:p,colFrom:y,colTo:I}of h)for(let v=y;v<=I;v++){const x=Ar.set(f,p,d.normalizeCol(v),d.getWorldForColumn(v)).id;if(Kt.add(x),!this.has(x)){const T=new xs.n(this.tileScheme,x);this._tiles.set(x,T),this._index.insert(T),this.tiles.push(T),at.added.push(T)}}for(let p=this.tiles.length-1;p>=0;p--){const y=this.tiles[p];Kt.has(y.id)||(this._tiles.delete(y.id),this.tiles.splice(p,1),this._index.remove(y),at.removed.push(y))}(at.added.length||at.removed.length)&&this.emit("update",at),Mr.Z.pool.release(u),Kt.clear(),at.added.length=0,at.removed.length=0}}var wr=M(9598);let ut=class extends k.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,L.YP)(()=>this.updating,c=>{this.remoteClient.invoke("setUpdating",c).catch(a=>{})}))}destroy(){var c,a;this.stop(),null==(c=this.controller)||c.destroy(),null==(a=this.processor)||a.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){var c,a,u;this._paused=!0,Array.isArray(null==(c=this.service)?void 0:c.source)&&(this.service.source.forEach(h=>h.close()),this.service.source.length=0),null==(a=this.tileStore)||a.updateTiles({added:[],removed:this.tileStore.tiles.map(h=>h.id)}),null==(u=this.tileStore)||u.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:c,config:a,tileInfo:u,tiles:h}){var d=this;return(0,U.Z)(function*(){var f,p,y;if(d._paused=!0,Array.isArray(null==(f=d.service)?void 0:f.source)&&(d.service.source.forEach(I=>I.close()),d.service.source.length=0),d.service=c,!d.tileStore||!(0,ee.fS)(d.tileStore.tileScheme.spatialReference,u.spatialReference)){const I=new wr.Z(W.Z.fromJSON(u));h.added.length=h.removed.length=0,null==(p=d.tileStore)||p.updateTiles({added:[],removed:d.tileStore.tiles.map(v=>v.id)}),null==(y=d.tileStore)||y.destroy(),d.tileStore=new Er(I),d._pendingTileUpdates.length=0}for(yield d._createProcessorAndController(a),yield d.update({config:a}),d.controller.resume(),d.tileStore.clear(),d.tileStore.updateTiles(h),d._paused=!1;d._pendingTileUpdates.length;)d.tileStore.updateTiles(d._pendingTileUpdates.pop())})()}updateTiles(c){var a=this;return(0,U.Z)(function*(){a._paused?a._pendingTileUpdates.push(c):a.tileStore.updateTiles(c)})()}update({config:c}){var a=this;return(0,U.Z)(function*(){const u=Ce.empty();return yield Promise.all([a.processor.update(u,c),a.controller.update(u,c)]),u.toJSON()})()}applyUpdate(c){var a=this;return(0,U.Z)(function*(){return a.controller.applyUpdate(Ce.create(c))})()}_createProcessorAndController(c){var a=this;return(0,U.Z)(function*(){yield Promise.all([a._handleControllerConfig(c),a._handleProcessorConfig(c)]),a.controller.processor=a.processor})()}_handleControllerConfig(c){var a=this;return(0,U.Z)(function*(){return a._createController(a.service,c)})()}_handleProcessorConfig(c){var a=this;return(0,U.Z)(function*(){return a._createProcessor(a.service,c)})()}_createController(c,a){var u=this;return(0,U.Z)(function*(){u.controller&&u.controller.destroy();const{tileStore:h,remoteClient:d}=u,f=new Fr({service:c,tileStore:h,remoteClient:d});return u.controller=f,f})()}_createProcessor(c,a){var u=this;return(0,U.Z)(function*(){const h=a.schema.processors[0].type,d=(yield function q(c){return"heatmap"===c?Promise.all([M.e(8592),M.e(7434)]).then(M.bind(M,67434)):Promise.all([M.e(3751),M.e(4654),M.e(3141),M.e(4522),M.e(8592),M.e(8460)]).then(M.bind(M,28460))}(h)).default,{remoteClient:f,tileStore:p}=u,y=new d({service:c,config:a,tileStore:p,remoteClient:f});return u.processor&&u.processor.destroy(),u.processor=y,y})()}};(0,K._)([(0,X.Cb)()],ut.prototype,"controller",void 0),(0,K._)([(0,X.Cb)()],ut.prototype,"processor",void 0),(0,K._)([(0,X.Cb)()],ut.prototype,"updating",null),(0,K._)([(0,X.Cb)()],ut.prototype,"viewState",void 0),ut=(0,K._)([(0,V.j)("esri.views.2d.layers.features.Pipeline")],ut);const Rr=ut},16669:(xe,ae,M)=>{M.d(ae,{J:()=>V});var U=M(15861),K=M(8314),k=M(62208),F=M(84682),L=M(46679),X=M(63290);const z=Promise.resolve().then(M.bind(M,22445));class V{constructor(W,q){this._canCacheExpressionValue=!1,this._sourceInfo=W,this._storage=q,this._bitsets={computed:q.getBitset(q.createBitset())}}get storage(){return this._storage}invalidate(){this._bitsets.computed.clear()}updateSchema(W,q){var b=this;return(0,U.Z)(function*(){const N=(0,F.Hg)(b._schema,q);if(b._schema=q,!q||(0,k.Wi)(N)||!(0,F.uD)(N,"attributes"))return;(0,K.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",N),b._bitsets.computed.clear(),W.targets[q.name]=!0;const E=q.attributes,P=[],_=[];for(const m in E){const S=E[m];switch(S.type){case"field":break;case"expression":P.push(b._createArcadeComputedField(S));break;case"label-expression":P.push(b._createLabelArcadeComputedField(S));break;case"statistic":_.push(S)}}b._computedFields=yield Promise.all(P),b._canCacheExpressionValue=!b._computedFields.some(m=>"expression"===m.type&&m.expression.referencesScale()),b._statisticFields=_})()}setComputedAttributes(W,q,b,N){const E=this._bitsets.computed;if(!this._canCacheExpressionValue||!E.has(b)){E.set(b);for(const P of this._computedFields){const _=this._evaluateField(q,P,N);switch(P.resultType){case"numeric":W.setComputedNumericAtIndex(b,P.fieldIndex,_);break;case"string":W.setComputedStringAtIndex(b,P.fieldIndex,_)}}}}_createArcadeComputedField(W){var q=this;return(0,U.Z)(function*(){const b=q._sourceInfo.spatialReference,N=q._sourceInfo.fieldsIndex;return Ae(me({},W),{expression:yield(0,L.Yi)(W.valueExpression,b,N)})})()}_createLabelArcadeComputedField(W){var q=this;return(0,U.Z)(function*(){const b=q._sourceInfo.spatialReference,N=q._sourceInfo.fieldsIndex,{createLabelFunction:E}=yield z,P=yield E(W.label,N,b);return Ae(me({},W),{builder:P})})()}_evaluateField(W,q,b){switch(q.type){case"label-expression":{const N=W.readArcadeFeature();return q.builder.evaluate(N)||""}case"expression":{const{expression:N}=q;return function ne(ee,W,q){ee.referencesGeometry();const b=W.readArcadeFeature();try{return ee.evaluate(Ae(me({},q),{$feature:b}))}catch(N){return X.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",N),null}}(N,W,{$view:{scale:b}})}}}}},25208:(xe,ae,M)=>{var O,R,Y;M.d(ae,{s:()=>A}),M(29132);var K=M(8314),k=M(62208),F=M(77044),L=M(82054),X=M(88071),ne=M(42797),z=M(91179);let V=0;const ee=null!=(O=(0,K.Z)("featurelayer-simplify-thresholds"))?O:[.5,.5,.5,.5],W=ee[0],q=ee[1],b=ee[2],N=ee[3],E=null!=(R=(0,K.Z)("featurelayer-simplify-payload-size-factors"))?R:[1,2,4],P=E[0],_=E[1],m=E[2],S=null!=(Y=(0,K.Z)("featurelayer-simplify-mobile-factor"))?Y:2,C=(0,K.Z)("esri-mobile");class A{constructor(w,G){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=w,this._layerSchema=G}static createInstance(){return V++,V=V>65535?0:V,V}get isEmpty(){return(0,k.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}set level(w){this._level=w}getAreaSimplificationThreshold(w,G){let J=1;const he=C?S:1;G>4e6?J=m*he:G>1e6?J=_*he:G>5e5?J=P*he:G>1e5&&(J=he);let ie=0;w>4e3?ie=N*J:w>2e3?ie=b*J:w>100?ie=q:w>15&&(ie=W);let ce=8;return this._level<4?ce=1:this._level<5?ce=2:this._level<6&&(ce=4),ie*ce}setArcadeSpatialReference(w){this._arcadeSpatialReference=w}attachStorage(w){this._storage=w}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(w){return this.getComputedNumericAtIndex(0)}setComputedNumeric(w,G){return this.setComputedNumericAtIndex(G,0)}getComputedString(w){return this.getComputedStringAtIndex(0)}setComputedString(w,G){return this.setComputedStringAtIndex(0,G)}getComputedNumericAtIndex(w){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),w)}setComputedNumericAtIndex(w,G){this._storage.setComputedNumericAtIndex(this.getDisplayId(),w,G)}getComputedStringAtIndex(w){return this._storage.getComputedStringAtIndex(this.getDisplayId(),w)}setComputedStringAtIndex(w,G){return this._storage.setComputedStringAtIndex(this.getDisplayId(),w,G)}transform(w,G,J,he){const ie=this.copy();return ie._tx+=w,ie._ty+=G,ie._sx*=J,ie._sy*=he,ie}readAttribute(w,G=!1){const J=this._readAttribute(w,G);if(void 0!==J)return J;for(const he of this._joined){he.setIndex(this.getIndex());const ie=he._readAttribute(w,G);if(void 0!==ie)return ie}}readAttributes(){const w=this._readAttributes();for(const G of this._joined){G.setIndex(this.getIndex());const J=G._readAttributes();for(const he of Object.keys(J))w[he]=J[he]}return w}joinAttributes(w){this._joined.push(w)}readArcadeFeature(){return this}geometry(){const w=this.readHydratedGeometry(),G=(0,L.di)(w,this.geometryType,this.hasZ,this.hasM),J=(0,z.im)(G);return J&&(J.spatialReference=this._arcadeSpatialReference),J}field(w){if(this.hasField(w))return this.readAttribute(w,!0);for(const G of this._joined)if(G.setIndex(this.getIndex()),G.hasField(w))return G._readAttribute(w,!0);throw new Error(`Field ${w} does not exist`)}setField(w,G){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.getFieldNames()}castToText(){return JSON.stringify(this.readLegacyFeature())}gdbVersion(){return null}fullSchema(){return this._layerSchema}castAsJson(w=null){return{attributes:this._readAttributes(),geometry:!0===(null==w?void 0:w.keepGeometryType)?this.geometry():this.geometry().toJSON()}}castAsJsonAsync(w=null,G=null){return Promise.resolve(this.castAsJson(G))}removeIds(w){if((0,k.Wi)(this._objectIdToIndex)){const J=new Map,he=this.getCursor();for(;he.next();)J.set(he.getObjectId(),he.getIndex());this._objectIdToIndex=J}const G=this._objectIdToIndex;for(const J of w)G.has(J)&&this.removeAtIndex(G.get(J))}removeAtIndex(w){(0,k.Wi)(this._deleted)&&(this._deleted=ne.p.create(this.getSize())),this._deleted.set(w)}readGeometryForDisplay(){return this.readUnquantizedGeometry(!0)}readLegacyGeometryForDisplay(){return this.readLegacyGeometry(!0)}*features(){const w=this.getCursor();for(;w.next();)yield w.readOptimizedFeature()}_getExists(){return(0,k.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const w=this.readUnquantizedGeometry();if(!w||w.hasIndeterminateRingOrder)return null;const G=(0,k.Pt)(this.getQuantizationTransform(),null);return(0,F.Y)(new X.Z,w,this.hasM,this.hasZ,G)}copyInto(w){w.seen=this.seen,w._storage=this._storage,w._arcadeSpatialReference=this._arcadeSpatialReference,w._joined=this._joined,w._tx=this._tx,w._ty=this._ty,w._sx=this._sx,w._sy=this._sy,w._deleted=this._deleted,w._objectIdToIndex=this._objectIdToIndex}}},52397:(xe,ae,M)=>{M.d(ae,{t:()=>K});var U=M(25208);class K extends U.s{constructor(F,L){super(U.s.createInstance(),F.fullSchema()),this._currentIndex=-1,this._reader=F,this._indices=L}static from(F,L){return new K(F.copy(),L)}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const F=new K(this._reader.copy(),this._indices);return F._currentIndex=this._currentIndex,F}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(F){this._reader.setArcadeSpatialReference(F)}attachStorage(F){this._reader.attachStorage(F)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(F){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(F,L){return this._reader.setComputedNumericAtIndex(L,0)}getComputedString(F){return this._reader.getComputedStringAtIndex(0)}setComputedString(F,L){return this._reader.setComputedStringAtIndex(0,L)}getComputedNumericAtIndex(F){return this._reader.getComputedNumericAtIndex(F)}setComputedNumericAtIndex(F,L){this._reader.setComputedNumericAtIndex(F,L)}getComputedStringAtIndex(F){return this._reader.getComputedStringAtIndex(F)}setComputedStringAtIndex(F,L){return this._reader.setComputedStringAtIndex(F,L)}transform(F,L,X,ne){const z=this.copy();return z._reader=this._reader.transform(F,L,X,ne),z}readAttribute(F,L=!1){return this._reader.readAttribute(F,L)}readAttributes(){return this._reader.readAttributes()}joinAttributes(F){return this._reader.joinAttributes(F)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(F){return this.readAttribute(F,!0)}hasField(F){return this._reader.hasField(F)}setField(F,L){return this._reader.setField(F,L)}keys(){return this._reader.keys()}castToText(){return this._reader.castToText()}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getFieldNames(){return this._reader.getFieldNames()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(F){return this._reader.setDisplayId(F)}getGroupId(){return this._reader.getGroupId()}setGroupId(F){return this._reader.setGroupId(F)}getXHydrated(){return this._reader.getXHydrated()}getYHydrated(){return this._reader.getYHydrated()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(F){return this._reader.setIndex(F)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(F,L){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},42797:(xe,ae,M)=>{M.d(ae,{p:()=>U});class U{constructor(k,F){this._mask=0,this._buf=k,this._mask=F}static fromBuffer(k,F){return new U(k,F)}static create(k,F=4294967295){const L=new Uint32Array(Math.ceil(k/32));return new U(L,F)}_getIndex(k){return Math.floor(k/32)}has(k){const F=this._mask&k;return!!(this._buf[this._getIndex(F)]&1<<F%32)}hasRange(k,F){let L=k,X=F;for(;L%32&&L!==X;){if(this.has(L))return!0;L++}for(;X%32&&L!==X;){if(this.has(L))return!0;X--}if(L===X)return!1;for(let ne=L/32;ne!==X/32;ne++)if(this._buf[ne])return!0;return!1}set(k){const F=this._mask&k,L=this._getIndex(F);this._buf[L]|=1<<F%32}setRange(k,F){let L=k,X=F;for(;L%32&&L!==X;)this.set(L++);for(;X%32&&L!==X;)this.set(X--);if(L!==X)for(let ne=L/32;ne!==X/32;ne++)this._buf[ne]=4294967295}unset(k){const F=this._mask&k,L=this._getIndex(F);this._buf[L]&=4294967295^1<<F%32}resize(k){const F=this._buf,L=new Uint32Array(Math.ceil(k/32));L.set(F),this._buf=L}or(k){for(let F=0;F<this._buf.length;F++)this._buf[F]|=k._buf[F];return this}and(k){for(let F=0;F<this._buf.length;F++)this._buf[F]&=k._buf[F];return this}xor(k){for(let F=0;F<this._buf.length;F++)this._buf[F]^=k._buf[F];return this}ior(k){for(let F=0;F<this._buf.length;F++)this._buf[F]|=~k._buf[F];return this}iand(k){for(let F=0;F<this._buf.length;F++)this._buf[F]&=~k._buf[F];return this}ixor(k){for(let F=0;F<this._buf.length;F++)this._buf[F]^=~k._buf[F];return this}any(){for(let k=0;k<this._buf.length;k++)if(this._buf[k])return!0;return!1}copy(k){for(let F=0;F<this._buf.length;F++)this._buf[F]=k._buf[F];return this}clone(){return new U(this._buf.slice(),this._mask)}clear(){for(let k=0;k<this._buf.length;k++)this._buf[k]=0}forEachSet(k){for(let F=0;F<this._buf.length;F++){let L=this._buf[F],X=32*F;if(L)for(;L;)1&L&&k(X),L>>>=1,X++}}countSet(){let k=0;return this.forEachSet(F=>{k++}),k}}},81340:(xe,ae,M)=>{M.d(ae,{n:()=>X});var U=M(35575),K=M(2004),k=M(65401),F=M(89621),L=M(58098);class X{constructor(z,V){this.key=new L.Z(0,0,0,0),this.bounds=(0,k.Ue)(),this.objectIds=new Set,this.key.set(V);const ee=z.getLODInfoAt(this.key);this.tileInfoView=z,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=ee.resolution,this.scale=ee.scale,this.level=ee.level}get id(){return this.key.id}get extent(){return K.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const z=this.key.getChildKeys(),V=U.Z.acquire();for(let ee=0;ee<z.length;ee++)V[ee]=new X(this.tileInfoView,z[ee]);return V}getQuantizationParameters(){return F.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}},84378:(xe,ae,M)=>{M.d(ae,{Z:()=>K});var U=M(27899);class K{constructor(){this.spans=[]}acquire(F){this.lodInfo=F}release(){this.lodInfo=null,this.spans.length=0}forEach(F,L){const{spans:X,lodInfo:ne}=this,{level:z}=ne;if(0!==X.length)for(const{row:V,colFrom:ee,colTo:W}of X)for(let q=ee;q<=W;q++)F.call(L,z,V,ne.normalizeCol(q),ne.getWorldForColumn(q))}}K.pool=new U.Z(K)},9598:(xe,ae,M)=>{M.d(ae,{Z:()=>E});var U=M(37053),K=M(62208),k=M(58098);function F(P,_){return[P,_]}function L(P,_,m){return P[0]=_,P[1]=m,P}const ne=new k.Z("0/0/0/0");class z{constructor(_,m,S,C,A,O,R,Y,Q,w,G,J){this.level=_,this.resolution=m,this.scale=S,this.origin=C,this.first=A,this.last=O,this.size=R,this.norm=Y,this.worldStart=Q,this.worldEnd=w,this.worldSize=G,this.wrap=J}static create(_,m,S=null){const C=(0,U.C5)(_.spatialReference),A=m.origin||F(_.origin.x,_.origin.y),O=F(_.size[0]*m.resolution,_.size[1]*m.resolution),R=F(-1/0,-1/0),Y=F(1/0,1/0),Q=F(1/0,1/0);(0,K.pC)(S)&&(L(R,Math.max(0,Math.floor((S.xmin-A[0])/O[0])),Math.max(0,Math.floor((A[1]-S.ymax)/O[1]))),L(Y,Math.max(0,Math.floor((S.xmax-A[0])/O[0])),Math.max(0,Math.floor((A[1]-S.ymin)/O[1]))),L(Q,Y[0]-R[0]+1,Y[1]-R[1]+1));const{cols:w,rows:G}=m;let J,he,ie,ce;return!S&&w&&G&&(L(R,w[0],G[0]),L(Y,w[1],G[1]),L(Q,w[1]-w[0]+1,G[1]-G[0]+1)),_.isWrappable?(J=F(Math.ceil(Math.round((C.valid[1]-C.valid[0])/m.resolution)/_.size[0]),Q[1]),he=F(Math.floor((C.origin[0]-A[0])/O[0]),R[1]),ie=F(J[0]+he[0]-1,Y[1]),ce=!0):(he=R,ie=Y,J=Q,ce=!1),new z(m.level,m.resolution,m.scale,A,R,Y,Q,O,he,ie,J,ce)}normalizeCol(_){if(!this.wrap)return _;const m=this.worldSize[0];return _<0?m-1-Math.abs((_+1)%m):_%m}denormalizeCol(_,m){return this.wrap?this.worldSize[0]*m+_:_}getWorldForColumn(_){return this.wrap?Math.floor(_/this.worldSize[0]):0}getFirstColumnForWorld(_){return _*this.worldSize[0]+this.first[0]}getLastColumnForWorld(_){return _*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(_){return(_-this.origin[0])/this.norm[0]}getXForColumn(_){return this.origin[0]+_*this.norm[0]}getRowForY(_){return(this.origin[1]-_)/this.norm[1]}getYForRow(_){return this.origin[1]-_*this.norm[1]}getTileBounds(_,m,S=!1){ne.set(m);const C=S?ne.col:this.denormalizeCol(ne.col,ne.world),A=ne.row;return function X(P,_,m,S,C){P[0]=_,P[1]=m,P[2]=S,P[3]=C}(_,this.getXForColumn(C),this.getYForRow(A+1),this.getXForColumn(C+1),this.getYForRow(A)),_}getTileCoords(_,m,S=!1){ne.set(m);const C=S?ne.col:this.denormalizeCol(ne.col,ne.world);return Array.isArray(_)?L(_,this.getXForColumn(C),this.getYForRow(ne.row)):(_.x=this.getXForColumn(C),_.y=this.getYForRow(ne.row)),_}}var V=M(84378);class ee{constructor(_,m,S){this.row=_,this.colFrom=m,this.colTo=S}}const W=new k.Z("0/0/0/0");class q{constructor(_,m,S,C,A,O,R,Y){this.x=_,this.ymin=m,this.ymax=S,this.invM=C,this.leftAdjust=A,this.rightAdjust=O,this.leftBound=R,this.rightBound=Y}static create(_,m){_[1]>m[1]&&([_,m]=[m,_]);const[S,C]=_,[A,O]=m,R=A-S,Y=O-C,Q=0!==Y?R/Y:0,w=(Math.ceil(C)-C)*Q,G=(Math.floor(C)-C)*Q;return new q(S,Math.floor(C),Math.ceil(O),Q,R<0?w:G,R<0?G:w,R<0?A:S,R<0?S:A)}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const b=[[0,0],[0,0],[0,0],[0,0]];class E{constructor(_,m=null){this.tileInfo=_,this.fullExtent=m,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};const S=_.lods.slice();S.sort((A,O)=>O.scale-A.scale);const C=this._lodInfos=S.map(A=>z.create(_,A,m));S.forEach((A,O)=>{this._infoByLevel[A.level]=C[O],this._infoByScale[A.scale]=C[O],this.scales[O]=A.scale},this),this._wrap=_.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(_){return this._infoByLevel["number"==typeof _?_:_.level]}getTileBounds(_,m,S=!1){W.set(m);const C=this._infoByLevel[W.level];return C?C.getTileBounds(_,W,S):_}getTileCoords(_,m,S=!1){W.set(m);const C=this._infoByLevel[W.level];return C?C.getTileCoords(_,W,S):_}getTileCoverage(_,m=192,S="closest"){const C="closest"===S?this.getClosestInfoForScale(_.scale):this.getSmallestInfoForScale(_.scale),A=V.Z.pool.acquire(C),O=this._wrap;let R,Y,Q,w=1/0,G=-1/0;const J=A.spans;b[0][0]=b[0][1]=b[1][1]=b[3][0]=-m,b[1][0]=b[2][0]=_.size[0]+m,b[2][1]=b[3][1]=_.size[1]+m;for(const oe of b)_.toMap(oe,oe),oe[0]=C.getColumnForX(oe[0]),oe[1]=C.getRowForY(oe[1]);const he=[];let ie=3;for(let oe=0;oe<4;oe++){if(b[oe][1]===b[ie][1]){ie=oe;continue}const Ie=q.create(b[oe],b[ie]);w=Math.min(Ie.ymin,w),G=Math.max(Ie.ymax,G),void 0===he[Ie.ymin]&&(he[Ie.ymin]=[]),he[Ie.ymin].push(Ie),ie=oe}if(null==w||null==G||G-w>100)return null;let ce=[];for(R=w;R<G;){null!=he[R]&&(ce=ce.concat(he[R])),Y=1/0,Q=-1/0;for(let oe=ce.length-1;oe>=0;oe--){const Ie=ce[oe];Y=Math.min(Y,Ie.getLeftCol()),Q=Math.max(Q,Ie.getRightCol())}if(Y=Math.floor(Y),Q=Math.floor(Q),R>=C.first[1]&&R<=C.last[1])if(O)if(C.size[0]<C.worldSize[0]){const oe=Math.floor(Q/C.worldSize[0]);for(let Ie=Math.floor(Y/C.worldSize[0]);Ie<=oe;Ie++)J.push(new ee(R,Math.max(C.getFirstColumnForWorld(Ie),Y),Math.min(C.getLastColumnForWorld(Ie),Q)))}else J.push(new ee(R,Y,Q));else Y>C.last[0]||Q<C.first[0]||(Y=Math.max(Y,C.first[0]),Q=Math.min(Q,C.last[0]),J.push(new ee(R,Y,Q)));R+=1;for(let oe=ce.length-1;oe>=0;oe--){const Ie=ce[oe];Ie.ymax>=R?Ie.incrRow():ce.splice(oe,1)}}return A}getTileParentId(_){W.set(_);const S=this._lodInfos.indexOf(this._infoByLevel[W.level])-1;return S<0?null:(this._getTileIdAtLOD(W,this._lodInfos[S],W),W.id)}getTileResolution(_){const m=this._infoByLevel["object"==typeof _?_.level:_];return m?m.resolution:-1}getTileScale(_){const m=this._infoByLevel[_.level];return m?m.scale:-1}intersects(_,m){W.set(m);const S=this._infoByLevel[W.level],C=_.lodInfo;if(C.resolution>S.resolution){this._getTileIdAtLOD(W,C,W);const O=C.denormalizeCol(W.col,W.world);for(const R of _.spans)if(R.row===W.row&&R.colFrom<=O&&R.colTo>=O)return!0}if(C.resolution<S.resolution){const[O,R,Y,Q]=_.spans.reduce((ce,oe)=>(ce[0]=Math.min(ce[0],oe.row),ce[1]=Math.max(ce[1],oe.row),ce[2]=Math.min(ce[2],oe.colFrom),ce[3]=Math.max(ce[3],oe.colTo),ce),[1/0,-1/0,1/0,-1/0]),w=S.denormalizeCol(W.col,W.world),G=C.getColumnForX(S.getXForColumn(w)),J=C.getRowForY(S.getYForRow(W.row)),he=C.getColumnForX(S.getXForColumn(w+1))-1,ie=C.getRowForY(S.getYForRow(W.row+1))-1;return!(G>Q||he<Y||J>R||ie<O)}const A=C.denormalizeCol(W.col,W.world);return _.spans.some(O=>O.row===W.row&&O.colFrom<=A&&O.colTo>=A)}normalizeBounds(_,m,S){if(_[0]=m[0],_[1]=m[1],_[2]=m[2],_[3]=m[3],this._wrap){const C=(0,U.C5)(this.tileInfo.spatialReference),A=-S*(C.valid[1]-C.valid[0]);_[0]+=A,_[2]+=A}return _}getSmallestInfoForScale(_){const m=this.scales;if(this._infoByScale[_])return this._infoByScale[_];if(_>m[0])return this._infoByScale[m[0]];for(let S=1;S<m.length-1;S++)if(_>m[S]+1e-6)return this._infoByScale[m[S-1]];return this._infoByScale[m[m.length-1]]}getClosestInfoForScale(_){const m=this.scales;return this._infoByScale[_]||(_=m.reduce((S,C)=>Math.abs(C-_)<Math.abs(S-_)?C:S,m[0])),this._infoByScale[_]}scaleToLevel(_){const m=this.scales;if(this._infoByScale[_])return this._infoByScale[_].level;for(let S=m.length-1;S>=0;S--)if(_<m[S])return S===m.length-1?this._infoByScale[m[m.length-1]].level:this._infoByScale[m[S]].level+(m[S]-_)/(m[S]-m[S+1]);return this._infoByScale[m[0]].level}scaleToZoom(_){return this.tileInfo.scaleToZoom(_)}_getTileIdAtLOD(_,m,S){const C=this._infoByLevel[S.level];return _.set(S),m.resolution<C.resolution?null:(m.resolution===C.resolution||(_.level=m.level,_.col=Math.floor(S.col*C.resolution/m.resolution+.01),_.row=Math.floor(S.row*C.resolution/m.resolution+.01)),_)}}},71251:(xe,ae,M)=>{M.d(ae,{e:()=>X});var U=M(62208),K=M(10699),k=M(35133),F=M(50618);class L{constructor(z,V){this.item=z,this.controller=V,this.promise=null}}class X{constructor(z){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,z.concurrency&&(this.concurrency=z.concurrency),this._queue=new k.Z(z.peeker),this.process=z.process;const V=z.scheduler;z.priority&&(0,U.pC)(V)&&(this._task=V.registerTask(z.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(z){const V=this._controllers.get(z);V&&V.abort()}clear(){this._queue.clear();const z=[];this._controllers.forEach(V=>z.push(V)),this._controllers.clear(),z.forEach(V=>V.abort()),this._processingItems.clear(),this._cancelNext()}forEach(z){this._deferreds.forEach((V,ee)=>z(ee))}get(z){const V=this._deferreds.get(z);return V?V.promise:void 0}isOngoing(z){return this._processingItems.has(z)}has(z){return this._deferreds.has(z)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(z,V){const ee=this.get(z);if(ee)return ee;const W=new AbortController;let q=null;V&&(q=(0,K.fu)(V,()=>W.abort()));const N=()=>{E.remove(),(0,U.pC)(q)&&q.remove(),this._deferreds.delete(z),this._controllers.delete(z),this._queue.remove(z),this._processingItems.delete(z),this._scheduleNext()},E=(0,K.$F)(W.signal,()=>{const _=this._processingItems.get(z);_&&_.controller.abort(),N(),P.reject((0,K.zE)())}),P=(0,K.dD)();return this._deferreds.set(z,P),this._controllers.set(z,W),P.promise.then(N,N),this._queue.push(z),this._scheduleNext(),P.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const z=[];this._processingItems.forEach(V=>z.push(V)),this._processingItems.clear();for(const V of z)this._queue.push(V.item),V.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const z=[];for(;this._queue.length;)z.push(this._queue.pop());return this.clear(),z}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(z){for(;!z.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),z.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=(0,F.Os)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(z,V){this._canProcessFulfillment(z)&&(this._scheduleNext(),this._deferreds.get(z.item).resolve(V))}_processError(z,V){this._canProcessFulfillment(z)&&(this._scheduleNext(),this._deferreds.get(z.item).reject(V))}_canProcessFulfillment(z){return!!this._deferreds.get(z.item)&&this._processingItems.get(z.item)===z}_process(z){if((0,U.Wi)(z))return;let V;const ee=new AbortController,W=new L(z,ee);this._processingItems.set(z,W);try{V=this.process(z,ee.signal)}catch(q){this._processError(W,q)}(0,K.y8)(V)?(W.promise=V,V.then(q=>this._processResult(W,q),q=>this._processError(W,q))):this._processResult(W,V)}get test(){return{update:z=>this.runTask(z)}}}}}]);